<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cumbia-websocket: Qt, cumbia, websocket, WebAssembly application setup and test</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cumbia-websocket
   &#160;<span id="projectnumber">1.x</span>
   </div>
   <div id="projectbrief">Qt widgets on top of the cumbia C++ library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Qt, cumbia, websocket, WebAssembly application setup and test </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Enabling multi engine support for a cumbia app allows executing one application to rely on different engines without any code modification. For instance, on platforms where Tango or EPICS control systems cannot be built, the application can fetch data through a proxy server over WebSockets or http. Applications that targeted only a specific enging (e.g. Tango), need a small modification to be ported to the corresponding <em>multi engine</em> version.</p>
<h3>Note</h3>
<p>It is recommended to enable the <em>multi engine</em> support <em>for all projects</em>, even for those intended to run on a specific engine only. This leaves the application open to rely on new engines in the future or face particular test environments.</p>
<h1>Setup Qt and cumbia for WebAssembly</h1>
<p>If you haven't done it yet, prepare and install the Qt and cumbia builds for WebAssembly described <a href="../../cumbia/html/cumbia_wasm.html">here</a>.</p>
<h3>Note</h3>
<p>In order to use the cumbia tools for development and testing, like <em>cumbia new project</em>, <em>cuuimake</em>, <em>cumbia read</em> or <em>cumbia client</em>, the <em>cumbia-libs</em> for C++ must be installed.</p>
<p>If they are installed under</p>
<div class="fragment"><div class="line">/home/test/.local/cumbia-libs/</div>
</div><!-- fragment --><p>you can execute</p>
<blockquote class="doxtable">
<p>source /home/test/.local/cumbia-libs/bin/cusetenv.sh </p>
</blockquote>
<p>to set up the environment in the current shell</p>
<h1>Build the <em>websocket server</em> for test purposes.</h1>
<p>The <em>websocket server</em> transforms client requests over WebSockets into engine-specific (Tango, EPICS) read and write operations. Results are sent back to the client over the same WebSocket. The <em>websocket server</em> is a C++ application that must have access to the desired control systems (Tango, EPICS) of which it is thus a <em>client</em>.</p>
<h3>Disclaimer</h3>
<p><em>cumbia-websocket-proxy-server</em> is a small Qt project uniquely aimed at testing websocket based C++ and WebAssembly applications and not intended for production.</p>
<h2>Download and build cumbia-websocket-proxy-server</h2>
<p>Download the sources</p>
<blockquote class="doxtable">
<p>cd ~/devel </p>
</blockquote>
<blockquote class="doxtable">
<p>git clone <a href="https://github.com/ELETTRA-SincrotroneTrieste/cumbia-websocket-proxy-server.git">https://github.com/ELETTRA-SincrotroneTrieste/cumbia-websocket-proxy-server.git</a> </p>
</blockquote>
<blockquote class="doxtable">
<p>cd cumbia-websocket-proxy-server </p>
</blockquote>
<p><em>NOTE</em> C++ qmake is used</p>
<blockquote class="doxtable">
<p>qmake INSTALL_ROOT=/home/test/.local/cumbia-libs </p>
</blockquote>
<blockquote class="doxtable">
<p>make -j9 &amp;&amp; make install </p>
</blockquote>
<h2>Start the cumbia-websocket-proxy-server</h2>
<p>The server can be run with the following command</p>
<blockquote class="doxtable">
<p>cumbia-websocket-proxy-server </p>
</blockquote>
<p>if the <code>bash source /home/test/.local/cumbia-libs/bin/cusetenv.sh</code> instruction has been previously imparted.</p>
<h1>Application setup for WebAssembly and websocket engine</h1>
<h2>1. Start a new project with cumbia-websocket engine support</h2>
<p>Start the <em>new project wizard</em></p>
<blockquote class="doxtable">
<p>cumbia new project </p>
</blockquote>
<p>In the top right <em>Support</em> box select <em>multi-engine</em></p>
<p>Fill in the required fields and click on the <em>Create</em> button.</p>
<p>Let's now inspect the skeleton generated by the wizard:</p>
<h3>Header file</h3>
<p>The header file exploits the <em>multi engine</em> functionalities offered by the <em>CumbiaPool</em> and <em>CuControlsFactoryPool</em>:</p>
<div class="fragment"><div class="line"><span class="keyword">private</span>:</div>
<div class="line">    Ui::MyApp *ui;</div>
<div class="line">    CumbiaPool *cu_pool;</div>
<div class="line">    CuControlsFactoryPool m_ctrl_factory_pool;</div>
</div><!-- fragment --><h3>CPP file</h3>
<p>The CPP skeleton file comes with plenty of comments. Substantially, since the application must be enabled to rely on different engines at runtime, it must be designed so that this adaptation does not require code change and recompilation.</p>
<p><em>QCommandLineParser</em> is used to determine whether the user launched the program with a parameter specifying the <em>websocket-url</em>. If so, <em>cumbia-websocket</em> engine is set up and <em>cumbia-tango</em> and <em>cumbia-epics</em> are left out. Exclusive engine loading allows the same syntax for sources and targets across the native and <em>proxied</em> engines (for instance <em>my/tango/device/attribute</em>, <em>$1/my_attribute</em>).</p>
<p>Websocket compatibility of source syntax with the Tango one is made possible by the <em>CuWsTangoReplaceWildcards</em> class, that mimics the <em><a class="elRef" href="../../qumbia-tango-controls/html/classCuTangoReplaceWildcards.html">CuTangoReplaceWildcards</a></em>, allowing for the <em>$x/attribute</em> and <em>$y-&gt;command</em> wildcards. Source <em>patterns</em> are provided by the CuWsTangoHelper.srcPatterns, that copies the src patterns defined by the Tango engine.</p>
<p>In the following section, the generated C++ file will be further commented.</p>
<p>Once the skeleton code is generated, you can proceed to editing. When the application is launched with the server address as option, the WebSocket engine is used. The native Tango (EPICS) engine is used otherwise.</p>
<h2>2. Migrate an engine specific project to a multi-engine support including cumbia-websocket</h2>
<p>If an existing <em>cumbia</em> project was created with a single engine in mind, a few code modifications are needed to port it to the multi engine form. In this example, we assume to be working on a Tango app:</p>
<h3>Header File</h3>
<p>The following lines</p>
<div class="fragment"><div class="line"><span class="comment">// cumbia-tango</span></div>
<div class="line"><span class="preprocessor">#include &lt;qulogimpl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutcontrolsreader_8h.html">cutcontrolsreader.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutcontrolswriter_8h.html">cutcontrolswriter.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiatango.h&gt;</span></div>
<div class="line"><span class="comment">// cumbia-tango</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MyTangoApp : <span class="keyword">public</span> QWidget</div>
<div class="line">{</div>
<div class="line">    Q_OBJECT</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">explicit</span> MyTangoApp(CumbiaTango *cut, QWidget *parent = 0); <span class="comment">// will change</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line">    CumbiaTango *cu_t;  <span class="comment">// will be removed</span></div>
<div class="line">    <a class="codeRef" href="../../qumbia-tango-controls/html/classCuTReaderFactory.html">CuTReaderFactory</a> cu_tango_r_fac; <span class="comment">// will be removed</span></div>
<div class="line">    <a class="codeRef" href="../../qumbia-tango-controls/html/classCuTWriterFactory.html">CuTWriterFactory</a> cu_tango_w_fac; <span class="comment">// will be removed</span></div>
</div><!-- fragment --><p>must be replaced by</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;qulogimpl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cucontrolsfactorypool.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>CumbiaPool;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Myapp : <span class="keyword">public</span> QWidget</div>
<div class="line">{</div>
<div class="line">    Q_OBJECT</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">explicit</span> Myapp(CumbiaPool *cu_p, QWidget *parent = 0); <span class="comment">// the constructor changes</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line">    CumbiaPool *cu_pool;   <span class="comment">// we need CumbiaPool</span></div>
<div class="line">    CuControlsFactoryPool m_ctrl_factory_pool;  <span class="comment">// we need CuControlsFactoryPool</span></div>
</div><!-- fragment --><h3>The <em>cpp</em> file</h3>
<p>The old constructor</p>
<div class="fragment"><div class="line">MyTangoApp::MyTangoApp(CumbiaTango *cut, QWidget *parent) : <span class="comment">// this is CumbiaTango specific</span></div>
<div class="line">    QWidget(parent)</div>
</div><!-- fragment --><p>will be replaced by the multi engine constructor (with CumbiaPool as first parameter)</p>
<div class="fragment"><div class="line">Myapp::Myapp(CumbiaPool *cumbia_pool, QWidget *parent) : QWidget(parent), ui(new <a class="codeRef" href="../../qumbia-epics-controls/html/namespaceUi.html">Ui</a>::Myapp)</div>
</div><!-- fragment --><p>this is removed</p>
<div class="fragment"><div class="line">ui-&gt;setupUi(<span class="keyword">this</span>, cu_t, cu_tango_r_fac, cu_tango_w_fac);</div>
</div><!-- fragment --><p>and a new piece of code needed to implement what described in the previous section must be introduced:</p>
<ul>
<li>includes: you can see the multiple engines support: EPICS, Tango, random, websocket:</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cumbiapool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuthreadfactoryimpl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuserviceprovider.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;qthreadseventbridgefactory.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumacros.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_EPICS_CONTROLS_VERSION</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiaepics.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-epics-controls/html/cuepcontrolsreader_8h.html">cuepcontrolsreader.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-epics-controls/html/cuepcontrolswriter_8h.html">cuepcontrolswriter.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuepics-world.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_TANGO_CONTROLS_VERSION</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiatango.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiatango.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutcontrolsreader_8h.html">cutcontrolsreader.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutcontrolswriter_8h.html">cutcontrolswriter.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cutango-world.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutcontrols-utils_8h.html">cutcontrols-utils.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#ifdef CUMBIA_RANDOM_VERSION</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiarandom.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;curndreader.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;curndactionfactories.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiarndworld.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef CUMBIA_WEBSOCKET_VERSION</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cumbiawebsocket_8h.html">cumbiawebsocket.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cumbiawsworld_8h.html">cumbiawsworld.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cuwscontrolsreader_8h.html">cuwscontrolsreader.h</a>&gt;</span> <span class="comment">// for CuWSReaderFactory</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cuwscontrolswriter_8h.html">cuwscontrolswriter.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuwstangoreplacewildcards.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuwstangohelper.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;QtDebug&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;QCommandLineOption&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;QCommandLineParser&gt;</span></div>
</div><!-- fragment --><p>The constructor becomes</p>
<div class="fragment"><div class="line">Myapp::Myapp(CumbiaPool *cumbia_pool, QWidget *parent) : QWidget(parent), ui(new <a class="codeRef" href="../../qumbia-epics-controls/html/namespaceUi.html">Ui</a>::Myapp)</div>
<div class="line">{</div>
<div class="line">    cu_pool = cumbia_pool;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_EPICS_CONTROLS_VERSION</span></div>
<div class="line">    CumbiaEpics* cuep = <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_TANGO_CONTROLS_VERSION</span></div>
<div class="line">    CumbiaTango* cuta = <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    QStringList engines;</div>
<div class="line"><span class="preprocessor">#ifdef CUMBIA_WEBSOCKET_VERSION</span></div>
<div class="line">    QCommandLineParser parser;</div>
<div class="line">    QCommandLineOption ws_url_o(QStringList() &lt;&lt; <span class="stringliteral">&quot;u&quot;</span> &lt;&lt; <span class="stringliteral">&quot;websocket-url&quot;</span>, <span class="stringliteral">&quot;URL to websocket server&quot;</span>, <span class="stringliteral">&quot;url&quot;</span>, <span class="stringliteral">&quot;ws://localhost:12702&quot;</span>);</div>
<div class="line">    parser.addHelpOption();</div>
<div class="line">    parser.addVersionOption();</div>
<div class="line">    parser.addOption(ws_url_o);</div>
<div class="line">    parser.process(*qApp);</div>
<div class="line">    QString ws_url;</div>
<div class="line">    <span class="keywordflow">if</span>(parser.isSet(ws_url_o))</div>
<div class="line">        ws_url = parser.value(ws_url_o);</div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// WebAssembly</span></div>
<div class="line">    <span class="comment">// -----------</span></div>
<div class="line">    <span class="comment">// Please read https://elettra-sincrotronetrieste.github.io/cumbia-libs/html/cumbia/html/cumbia_wasm.html</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// ws_url = &quot;ws://localhost:12702&quot;;  // if command line args is not working (see link above for patch)</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="keywordflow">if</span>(!ws_url.isEmpty()) {</div>
<div class="line">        <span class="comment">// setup Cumbia web socket with the web socket address and the host name to prepend to the sources</span></div>
<div class="line">        <span class="comment">// for the HTTP requests</span></div>
<div class="line">        <a class="code" href="classCumbiaWSWorld.html">CumbiaWSWorld</a> wsw;</div>
<div class="line">        <a class="code" href="classCumbiaWebSocket.html">CumbiaWebSocket</a>* cuws = <span class="keyword">new</span> <a class="code" href="classCumbiaWebSocket.html">CumbiaWebSocket</a>(ws_url, <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">new</span> CuThreadFactoryImpl(), <span class="keyword">new</span> QThreadsEventBridgeFactory());</div>
<div class="line">        cu_pool-&gt;registerCumbiaImpl(<span class="stringliteral">&quot;ws&quot;</span>, cuws);</div>
<div class="line">        m_ctrl_factory_pool.registerImpl(<span class="stringliteral">&quot;ws&quot;</span>, <a class="code" href="classCuWSReaderFactory.html">CuWSReaderFactory</a>());</div>
<div class="line">        m_ctrl_factory_pool.registerImpl(<span class="stringliteral">&quot;ws&quot;</span>, <a class="code" href="classCuWsControlsWriterFactory.html">CuWsControlsWriterFactory</a>());</div>
<div class="line">        <span class="comment">// example source: &quot;ws://tango://hokuto:20000/test/device/1/double_scalar&quot;</span></div>
<div class="line">        <span class="comment">// ws:// domain prefix will be discarded</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// case 1: websocket specific app</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// m_ctrl_factory_pool.setSrcPatterns(&quot;ws&quot;, wsw.srcPatterns());</span></div>
<div class="line">        <span class="comment">// cu_pool-&gt;setSrcPatterns(&quot;ws&quot;, wsw.srcPatterns());</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// case 2: access Tango through a websocket server</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// Share the same source syntax (e.g. $1/attribute, my/tango/dev/attribute)</span></div>
<div class="line">        <span class="comment">// across native tango engine and websocket proxy server.</span></div>
<div class="line">        <span class="comment">// This allows to leave the application code unchanged. See (*) below</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        CuWsTangoReplaceWildcards *tgrwi = <span class="keyword">new</span> CuWsTangoReplaceWildcards(<span class="comment">/*QStringList() &lt;&lt; &quot;test/device/1&quot;*/</span>);</div>
<div class="line">        cuws-&gt;<a class="code" href="classCumbiaWebSocket.html#a4ef8dc750e1ef0c850bfc06a56ebbc5a">addReplaceWildcardI</a>(tgrwi);</div>
<div class="line">        CuWsTangoHelper th;</div>
<div class="line">        m_ctrl_factory_pool.setSrcPatterns(<span class="stringliteral">&quot;ws&quot;</span>, th.srcPatterns());</div>
<div class="line">        cu_pool-&gt;setSrcPatterns(<span class="stringliteral">&quot;ws&quot;</span>, th.srcPatterns());</div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// open the websocket</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        cuws-&gt;<a class="code" href="classCumbiaWebSocket.html#af72b3afa235147a920ceeebe5543afa8">openSocket</a>();</div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        engines &lt;&lt; <span class="stringliteral">&quot;websocket&quot;</span>;</div>
<div class="line">    } <span class="comment">// parser.isSet(ws_url_o)</span></div>
<div class="line"><span class="preprocessor">#endif // #ifdef CUMBIA_WEBSOCKET_VERSION</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// (*) additional engines are registered if websocket is not in use so that applications</span></div>
<div class="line">    <span class="comment">// can rely either on websocket or other engines without changing the definition of</span></div>
<div class="line">    <span class="comment">// their sources (i.e. without code changes and rebuild)</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="keywordflow">if</span>(!cu_pool-&gt;get(<span class="stringliteral">&quot;ws&quot;</span>)) {</div>
<div class="line">        <span class="comment">// cumbia-random</span></div>
<div class="line"><span class="preprocessor">#ifdef CUMBIA_RANDOM_VERSION</span></div>
<div class="line">        CumbiaRandom *cura = <span class="keyword">new</span> CumbiaRandom(<span class="keyword">new</span> CuThreadFactoryImpl(), <span class="keyword">new</span> QThreadsEventBridgeFactory());</div>
<div class="line">        CumbiaRNDWorld rndw;</div>
<div class="line">        cu_pool-&gt;registerCumbiaImpl(<span class="stringliteral">&quot;random&quot;</span>, cura);</div>
<div class="line">        m_ctrl_factory_pool.registerImpl(<span class="stringliteral">&quot;random&quot;</span>, CuRNDReaderFactory());</div>
<div class="line">        m_ctrl_factory_pool.setSrcPatterns(<span class="stringliteral">&quot;random&quot;</span>, rndw.srcPatterns());</div>
<div class="line">        cu_pool-&gt;setSrcPatterns(<span class="stringliteral">&quot;random&quot;</span>, rndw.srcPatterns());</div>
<div class="line">        cura-&gt;getServiceProvider()-&gt;registerService(CuServices::Log, <span class="keyword">new</span> CuLog(&amp;m_log_impl));</div>
<div class="line">        engines &lt;&lt; <span class="stringliteral">&quot;random&quot;</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// EPICS</span></div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_EPICS_CONTROLS_VERSION</span></div>
<div class="line">        cuep = <span class="keyword">new</span> CumbiaEpics(<span class="keyword">new</span> CuThreadFactoryImpl(), <span class="keyword">new</span> QThreadsEventBridgeFactory());</div>
<div class="line">        cu_pool-&gt;registerCumbiaImpl(<span class="stringliteral">&quot;epics&quot;</span>, cuep);</div>
<div class="line">        m_ctrl_factory_pool.registerImpl(<span class="stringliteral">&quot;epics&quot;</span>, <a class="codeRef" href="../../qumbia-epics-controls/html/classCuEpReaderFactory.html">CuEpReaderFactory</a>());</div>
<div class="line">        m_ctrl_factory_pool.registerImpl(<span class="stringliteral">&quot;epics&quot;</span>, <a class="codeRef" href="../../qumbia-epics-controls/html/classCuEpWriterFactory.html">CuEpWriterFactory</a>());</div>
<div class="line">        cuep-&gt;getServiceProvider()-&gt;registerService(CuServices::Log, <span class="keyword">new</span> CuLog(&amp;m_log_impl));</div>
<div class="line">        CuEpicsWorld ew;</div>
<div class="line">        m_ctrl_factory_pool.setSrcPatterns(<span class="stringliteral">&quot;epics&quot;</span>, ew.srcPatterns());</div>
<div class="line">        cu_pool-&gt;setSrcPatterns(<span class="stringliteral">&quot;epics&quot;</span>, ew.srcPatterns());</div>
<div class="line">        engines &lt;&lt; <span class="stringliteral">&quot;epics&quot;</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Tango</span></div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_TANGO_CONTROLS_VERSION</span></div>
<div class="line">        cuta = <span class="keyword">new</span> CumbiaTango(<span class="keyword">new</span> CuThreadFactoryImpl(), <span class="keyword">new</span> QThreadsEventBridgeFactory());</div>
<div class="line">        cu_pool-&gt;registerCumbiaImpl(<span class="stringliteral">&quot;tango&quot;</span>, cuta);</div>
<div class="line">        m_ctrl_factory_pool.registerImpl(<span class="stringliteral">&quot;tango&quot;</span>, <a class="codeRef" href="../../qumbia-tango-controls/html/classCuTReaderFactory.html">CuTReaderFactory</a>());</div>
<div class="line">        m_ctrl_factory_pool.registerImpl(<span class="stringliteral">&quot;tango&quot;</span>, <a class="codeRef" href="../../qumbia-tango-controls/html/classCuTWriterFactory.html">CuTWriterFactory</a>());</div>
<div class="line">        cuta-&gt;getServiceProvider()-&gt;registerService(CuServices::Log, <span class="keyword">new</span> CuLog(&amp;m_log_impl));</div>
<div class="line">        CuTangoWorld tw;</div>
<div class="line">        m_ctrl_factory_pool.setSrcPatterns(<span class="stringliteral">&quot;tango&quot;</span>, tw.srcPatterns());</div>
<div class="line">        cu_pool-&gt;setSrcPatterns(<span class="stringliteral">&quot;tango&quot;</span>, tw.srcPatterns());</div>
<div class="line">        engines &lt;&lt; <span class="stringliteral">&quot;tango&quot;</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ui-&gt;setupUi(<span class="keyword">this</span>, cu_pool, m_ctrl_factory_pool);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// needs DEFINES -= QT_NO_DEBUG_OUTPUT in .pro</span></div>
<div class="line">    qDebug() &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; <span class="stringliteral">&quot;available engines&quot;</span> &lt;&lt; engines;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The comments in the code express the same concepts described in the previous section, <em>Start a new project with cumbia-websocket engine support</em>.</p>
<p>The example code needs to be inserted within the constructor of the application being ported to its <em>multi engine</em> version.</p>
<h3>Note 1</h3>
<p>Non necessary engines can be omitted by removing the sections within the <em>ifdef</em> sections, e.g. EPICS, random.</p>
<h3>Note 2</h3>
<p>No other change in the code should be necessary, unless you need to grab references to specific <em>Cumbia</em> objects, i.e. CumbiaTango or <a class="el" href="classCumbiaWebSocket.html">CumbiaWebSocket</a>.</p>
<p>In that case, the code to use will look like:</p>
<div class="fragment"><div class="line">CumbiaTango *c = <span class="keyword">static_cast&lt;</span>CumbiaTango *<span class="keyword">&gt;</span>(cu_pool-&gt;get(<span class="stringliteral">&quot;tango&quot;</span>));</div>
<div class="line"><span class="keywordflow">if</span>(c) {</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>and the old attributes referring to the CumbiaTango, <a class="elRef" href="../../qumbia-tango-controls/html/classCuTReaderFactory.html">CuTReaderFactory</a> or <a class="elRef" href="../../qumbia-tango-controls/html/classCuTWriterFactory.html">CuTWriterFactory</a> and declared in the header file will have to be removed.</p>
<h1>Build the application for WebAssembly</h1>
<h1>Run the C++ application for testing</h1>
<h1>Run the application in the browser</h1>
<blockquote class="doxtable">
<p>cd ~/devel </p>
</blockquote>
<blockquote class="doxtable">
<p>git clone <a href="https://github.com/emscripten-core/emsdk.git">https://github.com/emscripten-core/emsdk.git</a> </p>
</blockquote>
<blockquote class="doxtable">
<p>cd emsdk </p>
</blockquote>
<p>Qt and cumbia libraries have been tested with chromium browser, the Emscripten version 1.38.47 and Qt 5.14</p>
<blockquote class="doxtable">
<p>./emsdk install emscripten-1.38.47-fastcomp </p>
</blockquote>
<blockquote class="doxtable">
<p>./emsdk activate 1.38.47-fastcomp </p>
</blockquote>
<h2>Qt build and installation</h2>
<blockquote class="doxtable">
<p>cd ~/devel </p>
</blockquote>
<blockquote class="doxtable">
<p>git clone <a href="https://github.com/qt/qt5.git">https://github.com/qt/qt5.git</a> </p>
</blockquote>
<blockquote class="doxtable">
<p>cd qt </p>
</blockquote>
<blockquote class="doxtable">
<p>git checkout 5.14.2 </p>
</blockquote>
<blockquote class="doxtable">
<p>./init-repository </p>
</blockquote>
<h3>init-repository excluding some modules:</h3>
<blockquote class="doxtable">
<p>./init-repository &ndash;module-subset=all,-qtwayland,-qtx11extras,-qtwebengine,-qtpim,-qtquick3d,-qtmacextras </p>
</blockquote>
<p>Set the environment for <em>emscripten</em></p>
<blockquote class="doxtable">
<p>source ~/devel/emsdk/emsdk_env.sh </p>
</blockquote>
<h3>Command line arguments patch</h3>
<p>Check whether the following patch has been applied or not: it is important in order to pass command line arguments to applications</p>
<p><a href="https://codereview.qt-project.org/c/qt/qtbase/+/248624/6/src/plugins/platforms/wasm/qtloader.js#420">https://codereview.qt-project.org/c/qt/qtbase/+/248624/6/src/plugins/platforms/wasm/qtloader.js#420</a></p>
<h3>Configure, build and install</h3>
<p>Configure Qt with <em>-feature-thread</em>, skip tests and examples Further options can be found executing *./configure &ndash;help*</p>
<blockquote class="doxtable">
<p>./configure -xplatform wasm-emscripten -prefix /usr/local/qt-5.14.2-wasm -feature-thread -skip qtwebengine -skip qtquick3d -skip qtpurchasing -skip qtserialport -nomake examples -nomake tests -opensource -confirm-license &amp;&amp; make -j9 &amp;&amp; make install </p>
</blockquote>
<blockquote class="doxtable">
<p>make -j9 </p>
</blockquote>
<p>If you prefer, only a subset of modules can be built: <em>make module-qtbase module-qtdeclarative [other modules]</em></p>
<blockquote class="doxtable">
<p>[sudo] make install </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="aclassCumbiaWSWorld_html"><div class="ttname"><a href="classCumbiaWSWorld.html">CumbiaWSWorld</a></div><div class="ttdef"><b>Definition:</b> cumbiawsworld.h:10</div></div>
<div class="ttc" id="acutcontrolswriter_8h.html_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/cutcontrolswriter_8h.html">cutcontrolswriter.h</a></div></div>
<div class="ttc" id="acuepcontrolswriter_8h.html_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/cuepcontrolswriter_8h.html">cuepcontrolswriter.h</a></div></div>
<div class="ttc" id="acumbiawebsocket_8h_html"><div class="ttname"><a href="cumbiawebsocket_8h.html">cumbiawebsocket.h</a></div></div>
<div class="ttc" id="aclassCuTWriterFactory_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/classCuTWriterFactory.html">CuTWriterFactory</a></div></div>
<div class="ttc" id="acuepcontrolsreader_8h.html_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/cuepcontrolsreader_8h.html">cuepcontrolsreader.h</a></div></div>
<div class="ttc" id="anamespaceUi_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/namespaceUi.html">Ui</a></div></div>
<div class="ttc" id="acumbiawsworld_8h_html"><div class="ttname"><a href="cumbiawsworld_8h.html">cumbiawsworld.h</a></div></div>
<div class="ttc" id="aclassCuWsControlsWriterFactory_html"><div class="ttname"><a href="classCuWsControlsWriterFactory.html">CuWsControlsWriterFactory</a></div><div class="ttdoc">implements CuControlsWriterFactoryI and creates Websocket writers Given a pointer to a Cumbia object ...</div><div class="ttdef"><b>Definition:</b> cuwscontrolswriter.h:26</div></div>
<div class="ttc" id="aclassCumbiaWebSocket_html_a4ef8dc750e1ef0c850bfc06a56ebbc5a"><div class="ttname"><a href="classCumbiaWebSocket.html#a4ef8dc750e1ef0c850bfc06a56ebbc5a">CumbiaWebSocket::addReplaceWildcardI</a></div><div class="ttdeci">void addReplaceWildcardI(QuReplaceWildcards_I *rwi)</div><div class="ttdef"><b>Definition:</b> cumbiawebsocket.cpp:134</div></div>
<div class="ttc" id="aclassCuTReaderFactory_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/classCuTReaderFactory.html">CuTReaderFactory</a></div></div>
<div class="ttc" id="aclassCuEpWriterFactory_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/classCuEpWriterFactory.html">CuEpWriterFactory</a></div></div>
<div class="ttc" id="acutcontrolsreader_8h.html_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/cutcontrolsreader_8h.html">cutcontrolsreader.h</a></div></div>
<div class="ttc" id="aclassCumbiaWebSocket_html_af72b3afa235147a920ceeebe5543afa8"><div class="ttname"><a href="classCumbiaWebSocket.html#af72b3afa235147a920ceeebe5543afa8">CumbiaWebSocket::openSocket</a></div><div class="ttdeci">void openSocket()</div><div class="ttdef"><b>Definition:</b> cumbiawebsocket.cpp:125</div></div>
<div class="ttc" id="acuwscontrolswriter_8h_html"><div class="ttname"><a href="cuwscontrolswriter_8h.html">cuwscontrolswriter.h</a></div></div>
<div class="ttc" id="acutcontrols-utils_8h.html_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/cutcontrols-utils_8h.html">cutcontrols-utils.h</a></div></div>
<div class="ttc" id="aclassCuEpReaderFactory_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/classCuEpReaderFactory.html">CuEpReaderFactory</a></div></div>
<div class="ttc" id="aclassCumbiaWebSocket_html"><div class="ttname"><a href="classCumbiaWebSocket.html">CumbiaWebSocket</a></div><div class="ttdef"><b>Definition:</b> cumbiawebsocket.h:310</div></div>
<div class="ttc" id="acuwscontrolsreader_8h_html"><div class="ttname"><a href="cuwscontrolsreader_8h.html">cuwscontrolsreader.h</a></div></div>
<div class="ttc" id="aclassCuWSReaderFactory_html"><div class="ttname"><a href="classCuWSReaderFactory.html">CuWSReaderFactory</a></div><div class="ttdef"><b>Definition:</b> cuwscontrolsreader.h:11</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 10 2020 17:25:07 for cumbia-websocket by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
