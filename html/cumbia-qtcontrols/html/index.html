<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cumbia-qtcontrols: Cumbia Qt controls module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cumbia-qtcontrols
   &#160;<span id="projectnumber">1.x</span>
   </div>
   <div id="projectbrief">Qt widgets on top of the cumbia C++ library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Cumbia Qt controls module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Introduction"></a>
Introduction</h1>
<p>This module combines cumbia to the <em>Qt</em> cross platform software framework, offering graphical control system components. Labels, gauges and advanced graphs are supplied, as well as buttons and boxes to set values. As mentioned earlier, elementary data representation is provided, due to the component unawareness of the <em>cumbia</em> engine lying beneath. In order to display real data on the controls, you have to combine different building blocks at the moment of setting up each reader or writer in your application, as described later. When data is ready, it is delivered to the main thread through the onUpdate method that there must be in the control component (such as a label), for it must implement the <em>CuDataListener</em> interface. For an event loop must be executing, messages are posted to the main thread relying on an implementation of the <em>CuThreadsEventBridge_I</em> interface. In <em>Qt</em>, we use <em>QCoreApplication’s</em> event loop in conjunction with <em>cumbia-qtcontrols’</em> <em><a class="el" href="classQThreadsEventBridge.html" title="an event bridge to post a CuEventI event to a QApplication">QThreadsEventBridge</a></em>, which exploits <em>QCoreApplication’s</em> <em>postEvent</em>, a familiar scheme for <em>Qt</em> developers. From within <em>onUpdate</em>, data is extracted and presented to the user by way of the control widget.</p>
<p>Not strictly related to widgets themselves, but targeted to associate with them are a couple of abstract classes that define an interface to readers and writers. They compel readers and writers to provide methods to set and remove sources and targets of execution, as well as means to send and receive messages to and from actions. <em><a class="el" href="classCuControlsReaderA.html" title="abstract class defining an interface for cumbia-qtcontrols readers">CuControlsReaderA</a></em> and <em><a class="el" href="classCuControlsWriterA.html" title="abstract class defining an interface for cumbia-qtcontrols writers">CuControlsWriterA</a></em>, that’s their names, keep also references to the currently active <em>Cumbia</em> and data listener instances. Object composition to accomplish the set up of a <em>Tango</em> (<em>Epics</em>) reader (writer) will be discussed in the <em>cumbia-tango-controls</em> documentation.</p>
<h2><a class="anchor" id="context_menu"></a>
Widget context menu, properties and &lt;em&gt;helper application&lt;/em&gt; support</h2>
<p><em>cumbia-qtcontrols</em> widgets provide a contextual menu offering the following actions: </p><ul>
<li><em>link statistics</em>: an information dialog with details of the source and its health; </li>
<li><em>helper application</em>: available if a <em>free property</em> named <em>helperApplication</em> is set on the widget.</li>
</ul>
<h1><a class="anchor" id="related_readings"></a>
Related readings</h1>
<h2><a class="anchor" id=""></a>
</h2>
<p><a href="https://elettra-sincrotronetrieste.github.io/cumbia-libs/index.html">cumbia-libs</a> on github.io</p>
<h2><a class="anchor" id="tutorials"></a>
Tutorials</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Tutorials  </th><th class="markdownTableHeadCenter">Module   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cumbia/html/tutorial_cuactivity.html">Writing a <em>cumbia</em> activity</a>  </td><td class="markdownTableBodyCenter"><a href="../../cumbia/html/index.html">cumbia</a>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../cumbia-tango/html/tutorial_activity.html">Writing an activity</a>  </td><td class="markdownTableBodyCenter"><a href="../../cumbia-tango/html/index.html">cumbia-tango</a>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cumbia-tango/html/cudata_for_tango.html">CuData for Tango</a>  </td><td class="markdownTableBodyCenter"><a href="../../cumbia-tango/html/index.html">cumbia-tango</a>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../qumbia-tango-controls/html/tutorial_cumbiatango_widget.html">Writing a Qt widget that integrates with cumbia</a>  </td><td class="markdownTableBodyCenter"><a href="../../qumbia-tango-controls/html/index.html">qumbia-tango-controls</a>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cuuimake/html/cuuimake.html">Using <em>cumbia ui make</em></a> to process Qt designer UI files  </td><td class="markdownTableBodyCenter"><a href="../../cuuimake/html/index.html">qumbia-apps/cuuimake</a>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../qumbiaprojectwizard/html/tutorial_qumbiatango.html">Writing a <em>Qt application</em> with cumbia and Tango</a>.  </td><td class="markdownTableBodyCenter"><a href="../../qumbiaprojectwizard/html/index.html">qumbia-apps/qumbiaprojectwizard</a>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../qumbiaprojectwizard/html/tutorial_from_qtango.html">Porting a <em>QTango application</em> to <em>cumbia-tango</em></a>.  </td><td class="markdownTableBodyCenter"><a href="../../qumbiaprojectwizard/html/index.html">qumbia-apps/qumbiaprojectwizard</a>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../qumbianewcontrolwizard/html/tutorial_qumbianewcontrolwizard.html"><em>cumbia new control</em></a>: quickly add a custom Qt widget to a cumbia project  </td><td class="markdownTableBodyCenter"><a href="../../qumbianewcontrolwizard/html/index.html">qumbia-apps/qumbianewcontrolwizard</a>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cumbia-qtcontrols/html/understanding_cumbia_qtcontrols_constructors.html">Understanding <em>cumbia-qtcontrols constructors, sources and targets</em></a>  </td><td class="markdownTableBodyCenter"><a href="../../cumbia-qtcontrols/html/index.html">cumbia-qtcontrols</a>.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../qumbia-tango-controls/html/tutorial_faq.html">Frequently Asked Questions (Tango)</a>  </td><td class="markdownTableBodyCenter"><a href="../../qumbia-tango-controls/html/index.html">qumbia-tango-controls</a>   </td></tr>
</table>
<h2><a class="anchor" id="cumodules"></a>
Modules</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Other <em>cumbia</em> modules   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cumbia/html/index.html">cumbia module</a>.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../cumbia-tango/html/index.html">cumbia-tango module</a>.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cumbia-qtcontrols/html/index.html">cumbia-qtcontrols module</a>.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../qumbia-tango-controls/html/index.html">qumbia-tango-controls module</a>.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cumbia-epics/html/index.html">qumbia-epics module</a>.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="../../qumbia-epics-controls/html/index.html">qumbia-epics-controls module</a>.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="../../cumbia-qtcontrols/html/qumbia_plugins.html">qumbia-plugins module</a>.   </td></tr>
</table>
<h2><a class="anchor" id="cu_apps"></a>
apps</h2>
<p>These applications (and their documentation, that has already been mentioned in the <em>Tutorials</em> table above) must be installed from the <em>qumbia-apps</em> sub-directory of the <em>cumbia-libs</em> distribution. To install them, <em>cd</em> into that folder and execute:</p>
<div class="fragment"><div class="line">qmake</div><div class="line">make</div><div class="line">sudo make install</div></div><!-- fragment --><p>Along the applications executables and documentation, two bash scripts will be installed:</p>
<ul>
<li>/etc/bash_completion.d/cumbia</li>
<li>/etc/bash/bashrc.d/cumbia.sh</li>
</ul>
<p>They define shortcuts for the common operations provided by the <em>qumbia-apps</em> applications as follows:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Applications (command line)  </th><th class="markdownTableHeadNone">description  </th><th class="markdownTableHeadCenter">app   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>cumbia new project</em>  </td><td class="markdownTableBodyNone">create a new cumbia project  </td><td class="markdownTableBodyCenter"><a href="../../qumbiaprojectwizard/html/index.html">qumbia-apps/qumbiaprojectwizard</a>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>cumbia import</em>  </td><td class="markdownTableBodyNone">migrate a QTango project into cumbia  </td><td class="markdownTableBodyCenter"><a href="../../qumbiaprojectwizard/html/index.html">qumbia-apps/qumbiaprojectwizard</a>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>cumbia new control</em>  </td><td class="markdownTableBodyNone">write a <em>cumbia control</em> reader or writer  </td><td class="markdownTableBodyCenter"><a href="../../qumbianewcontrolwizard/html/index.html">qumbia-apps/qumbianewcontrolwizard</a>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>cumbia ui make</em>  </td><td class="markdownTableBodyNone">run <em>cuuimake</em> to generate <em>qt+cumbia</em> ui_*.h files  </td><td class="markdownTableBodyCenter"><a href="../../cuuimake/html/index.html">qumbia-apps/cuuimake</a>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>cumbia client</em>  </td><td class="markdownTableBodyNone">run a generic cumbia client  </td><td class="markdownTableBodyCenter"><a href="../../cumbia_client/html/index.html">qumbia-apps/cumbia_client</a>   </td></tr>
</table>
<p><em>bash auto completion</em> will help you use these shortcuts: try</p>
<div class="fragment"><div class="line">cumbia &lt;TAB&gt;</div></div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line">cumbia new &lt;TAB&gt;</div></div><!-- fragment --><h1><a class="anchor" id="DeveloperObs"></a>
Observations for developers</h1>
<h2><a class="anchor" id="Unlinking"></a>
Unlinking a source from cumbia</h2>
<p>Example: reader implemented in the cumbia-tango and qumbia-tango-controls modules. Every Cumbia Qt controls widget holds a reference to a <a class="el" href="classCuControlsReaderA.html" title="abstract class defining an interface for cumbia-qtcontrols readers">CuControlsReaderA</a> object. The unsetSource method, called from the main thread, is used to unlink a reader from cumbia. Let's take <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> as an example. <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> is a graphical Qt element representing a text label to display values. <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> implements the CuDataListener interface to receive updates from the underline reader. <a class="el" href="classQuLabel.html#abd504f8f2129310b6fc6fb6e95904bb3">QuLabel::unsetSource</a> calls</p>
<h3><a class="anchor" id="mainthread1"></a>
In the main thread</h3>
<p><a class="el" href="classCuControlsReaderA.html#a3eb494873fbfcce419c31d4b9165b7d0" title="disconnect the source">CuControlsReaderA::unsetSource</a> on the specific <a class="el" href="classCuControlsReaderA.html" title="abstract class defining an interface for cumbia-qtcontrols readers">CuControlsReaderA</a> implementation. </p><ul>
<li><a class="elRef" doxygen="/archivi/devel/utils/git/cppqtclients/cumbia-libs/qumbia-tango-controls/doc/qumbia-tango-controls.tag:../../qumbia-tango-controls/html/" href="../../qumbia-tango-controls/html/classCuTControlsReader.html">CuTControlsReader</a> is an implementation of <a class="el" href="classCuControlsReaderA.html" title="abstract class defining an interface for cumbia-qtcontrols readers">CuControlsReaderA</a> from the qumbia-tango-controls module. <a class="elRef" doxygen="/archivi/devel/utils/git/cppqtclients/cumbia-libs/qumbia-tango-controls/doc/qumbia-tango-controls.tag:../../qumbia-tango-controls/html/" href="../../qumbia-tango-controls/html/classCuTControlsReader.html#a04a292932322ed33ac19b86741c4ddd9">CuTControlsReader::unsetSource</a> is called. </li>
<li><a class="elRef" doxygen="/archivi/devel/utils/git/cppqtclients/cumbia-libs/qumbia-epics-controls/doc/qumbia-epics-controls.tag:../../qumbia-epics-controls/html/" href="../../qumbia-epics-controls/html/classCuEpControlsReader.html">CuEpControlsReader</a> is an implementation of <a class="el" href="classCuControlsReaderA.html" title="abstract class defining an interface for cumbia-qtcontrols readers">CuControlsReaderA</a> from the qumbia-epics-controls module. <a class="elRef" doxygen="/archivi/devel/utils/git/cppqtclients/cumbia-libs/qumbia-epics-controls/doc/qumbia-epics-controls.tag:../../qumbia-epics-controls/html/" href="../../qumbia-epics-controls/html/classCuEpControlsReader.html#af8b45cfb36078a60dc371f31736de007">CuEpControlsReader::unsetSource</a> is called. These implementations call CumbiaTango::unlinkListener for CuTangoActionI::AttConfig and CuTangoActionI::Reader action types in a row. CumbiaTango::unlinkListener performs a search among all the registered CuTangoActionI actions by name and type. It then removes a listener from the action found, by calling removeDataListener on the CuTangoActionI. In our example, CuTReader::removeDataListener is called. The removeDataListener method of CuTReader removes the data listener from the list of listeners it holds. This immediately prevents the listener to receive further data. In our example, the listener is <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a>.</li>
</ul>
<dl class="section user"><dt>notes</dt><dd><ul>
<li><a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> will not be updated right after <a class="el" href="classQuLabel.html#abd504f8f2129310b6fc6fb6e95904bb3">QuLabel::unsetSource</a>. </li>
<li>CuTReader, holding a list of registered listeners, may decide to call CuTReader::stop if the list of listeners is empty. Actually, one CuTReader can update several listeners connected to the same source.</li>
</ul>
CuTReader::stop calls Cumbia::unregisterActivity, passing the current activity as argument. In the case of the Tango CuTReader, the activity can be either CuPollingActivity or CuEventActivity. Cumbia::unregisterActivity fetches the thread where the activity belongs through the CuActivityManager service and calls CuThread::unregisterActivity on it. CuThread::unregisterActivity grabs the lock on its event queue and enqueues an event of type UnRegisterActivityEvent, to be processed in CuThread's thread execution context.</dd></dl>
<h3><a class="anchor" id="cuthread"></a>
In the CuThread's thread</h3>
<p>In CuThread's execution thread the UnRegisterActivityEvent holds a reference to the CuActivity that has to be stopped. CuActivity::doOnExit is called in the CuThread's thread. CuActivity::doOnExit is a &lt;cite&gt;template method&lt;/cite&gt;: sets the activity flags (an exit flag is activated) and calls the pure virtual method CuActivity::onExit. In our example, CuTReader can be executing a CuPollingActivity or a CuEventActivity. In the second case, CuEventActivity::onExit is called. As in every CuActivity::init, CuActivity::execute and CuActivity::onExit, the execution takes place in the CuThread's thread. So, CuEventActivity::onExit is the place where <em>Tango</em> event unsubscription takes place. As usual within CuActivity::init, CuActivity::execute and CuActivity::onExit, a CuData object is prepared in order to hand results to a CuDataListener (our <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a>) in the main thread. As you can see from CuEventActivity::onExit, CuActivity::publishResult is finally invoked.</p>
<p>CuActivity::publishResult receives the CuData that must be transmitted to the CuDataListener in the main thread. Here, through the CuActivityManager::getThread, the CuThread where the activity belongs is retrieved. CuActivityManager is a service (CuServiceI), only one instance is available and registered in Cumbia.</p>
<p>CuActivityManager::getThread grabs a lock on its thread list and returns the thread to that the activity was assigned. CuActivityManager's thread list is actually a multi map: more CuActivity objects can live in the same thread. In the Tango example, the cumbia-tango module chose to assign all activities referring to the same Tango device to the same CuThread. In other words distinct Tango devices, different threads.</p>
<p>When CuActivity::publishResult gets its thread, calls CuThread::publishResult on it.</p>
<p>CuThread::publishResult relies on the installed CuThreadsEventBridge_I implementation to post an event from the CuThread's secondary thread to the main thread. In a Qt application, the Qt event loop is normally used and the <a class="el" href="classQThreadsEventBridge.html" title="an event bridge to post a CuEventI event to a QApplication">QThreadsEventBridge</a> will invoke QCoreApplication::postEvent on the QApplication so as to deliver the CuData to the main thread (the "ui" thread).</p>
<p>We are ready to go back to the main execution thread.</p>
<h3><a class="anchor" id="mainthread2"></a>
(Back) In the main thread</h3>
<dl class="section note"><dt>Note</dt><dd>If instead of calling <a class="el" href="classQuLabel.html#abd504f8f2129310b6fc6fb6e95904bb3">QuLabel::unsetSource</a> the <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> had been directly deleted, <a class="el" href="classQuLabel.html#abd504f8f2129310b6fc6fb6e95904bb3">QuLabel::unsetSource</a> would have destroyed <a class="elRef" doxygen="/archivi/devel/utils/git/cppqtclients/cumbia-libs/qumbia-tango-controls/doc/qumbia-tango-controls.tag:../../qumbia-tango-controls/html/" href="../../qumbia-tango-controls/html/classCuTControlsReader.html">CuTControlsReader</a>, which in turn would have called <a class="elRef" doxygen="/archivi/devel/utils/git/cppqtclients/cumbia-libs/qumbia-tango-controls/doc/qumbia-tango-controls.tag:../../qumbia-tango-controls/html/" href="../../qumbia-tango-controls/html/classCuTControlsReader.html#a04a292932322ed33ac19b86741c4ddd9">CuTControlsReader::unsetSource</a>. <br />
 <em>At this time, <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> would not exist anymore, and not even the <a class="elRef" doxygen="/archivi/devel/utils/git/cppqtclients/cumbia-libs/qumbia-tango-controls/doc/qumbia-tango-controls.tag:../../qumbia-tango-controls/html/" href="../../qumbia-tango-controls/html/classCuTControlsReader.html">CuTControlsReader</a></em>. Anyway, the underline activity is still there, receiving events from CuThread. They will simply not be delivered to the deleted CuDataListener. <em>Also CuTReader is still alive</em>. CuTReader is deleted only after it receives a CuData with the "exit" flag set to true from the CuThread, in CuTReader::onResult.</dd></dl>
<p>At the end of the section <em>In the CuThread's thread</em> we left the CuThread's thread execution with an event bridge (with QApplication event system) posting an event on the main thread. That's where we are now.</p>
<p><a class="el" href="classQThreadsEventBridge.html" title="an event bridge to post a CuEventI event to a QApplication">QThreadsEventBridge</a> is a QObject, so it receives events received with QCoreApplication::postEvent within the <a class="el" href="classQThreadsEventBridge.html#a8e148b2d494b459b2eb8c1c38d2697dc" title="receives a QEvent from QApplication and delivers the contents to a registered CuThreadsEventBridgeLis...">QThreadsEventBridge::event</a> method. <a class="el" href="classQThreadsEventBridge.html" title="an event bridge to post a CuEventI event to a QApplication">QThreadsEventBridge</a> implements CuThreadsEventBridge_I and holds a reference to CuThreadsEventBridgeListener, which interface in turn is implemented by CuThread. <a class="el" href="classQThreadsEventBridge.html#a8e148b2d494b459b2eb8c1c38d2697dc" title="receives a QEvent from QApplication and delivers the contents to a registered CuThreadsEventBridgeLis...">QThreadsEventBridge::event</a> invokes CuThread::onEventPosted</p>
<p>The event carried by CuThread::onEventPosted contains the destination activity and the data for it. Through the CuActivityManager::getThreadListeners method, the list of CuThreadListner is fetched. We remember that CuTReader implements CuTangoActionI that implements CuThreadListener. So, our CuTReader will receive the data coming from the CuThread through CuTReader::onProgress or CuTReader::onResult. Let's consider the CuTReader::onResult case.</p>
<p>CuTReader::onResult, and this is the end of the long story, delivers the CuData to all the registered CuDataListener objects, like <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> in our discussion, through <a class="el" href="classQuLabel.html#ac4d740169e8b996ce3fcf4176114eb12">QuLabel::onUpdate</a>.</p>
<p>Inside <a class="el" href="classQuLabel.html#ac4d740169e8b996ce3fcf4176114eb12">QuLabel::onUpdate</a> it is important to avoid making calls that could potentially modify in place the list of registered CuDataListener. This means calling unsetSource (or setSource with the same source name) is therein discouraged. Delay setSource or unsetSource somehow outside <a class="el" href="classQuLabel.html#ac4d740169e8b996ce3fcf4176114eb12">QuLabel::onUpdate</a>.</p>
<h1><a class="anchor" id="Migrating"></a>
QTango readers to cumbia or writing a cumbia reader.</h1>
<p>A QTango reader typically implements a couple of methods of QTangoComProxyReader and some methods from QTangoWidgetCommon. In cumbia these classes have completely disappeared. Multiple class inheritance has been completely dropped in favor of interface only inheritance.</p>
<div class="fragment"><div class="line"><span class="preprocessor">    #include &lt;com_proxy_reader.h&gt;</span></div><div class="line"><span class="preprocessor">    #include &lt;qtango_wcommon.h&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">// In cumbia inheritance from QTangoComProxyReader and QTangoWidgetCommon</span></div><div class="line">    <span class="comment">// must be removed</span></div><div class="line">    <span class="keyword">class </span>TLabel : <span class="keyword">public</span> <a class="code" href="classELabel.html">ELabel</a>, <span class="keyword">public</span> QTangoComProxyReader, <span class="keyword">public</span> QTangoWidgetCommon</div><div class="line">    {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    TLabel(QWidget *parent, Qt::WindowFlags f = 0);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> ~TLabel();</div><div class="line"></div><div class="line"><span class="keyword">protected</span> slots:</div><div class="line"></div><div class="line">    <span class="comment">// cumbia: these two slots must be removed, as well as a</span></div><div class="line">    <span class="comment">// all connect(qtangoComHandle(), signal/slot connections in the .cpp file</span></div><div class="line">    <span class="keywordtype">void</span> refresh(<span class="keyword">const</span> TVariant &amp;);</div><div class="line">    <span class="keywordtype">void</span> configure(<span class="keyword">const</span> TangoConfigurationParameters*);</div><div class="line"></div><div class="line">    };</div></div><!-- fragment --><p>The QTango class skeleton above would look like this in cumbia:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;esimplelabel.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cudatalistener.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cucontexti_8h.html">cucontexti.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>QuLabelPrivate;</div><div class="line"><span class="keyword">class </span>CuData;</div><div class="line"><span class="keyword">class </span>Cumbia;</div><div class="line"><span class="keyword">class </span>CumbiaPool;</div><div class="line"><span class="keyword">class </span><a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a>;</div><div class="line"><span class="keyword">class </span><a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a>;</div><div class="line"><span class="keyword">class </span><a class="code" href="classCuContext.html">CuContext</a>;</div><div class="line"></div><div class="line"><span class="keyword">class </span><a class="code" href="classQuLabel.html">QuLabel</a> : <span class="keyword">public</span> ESimpleLabel, <span class="keyword">public</span> CuDataListener, <span class="keyword">public</span> <a class="code" href="classCuContextI.html">CuContextI</a></div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line">    <span class="comment">// source property, same property name, getter and setter as QTango&#39;s</span></div><div class="line">    Q_PROPERTY(QString <a class="code" href="classQuLabel.html#a4af093529f2c0a67a49491f817ed637a">source</a> READ <a class="code" href="classQuLabel.html#a4af093529f2c0a67a49491f817ed637a">source</a> WRITE <a class="code" href="classQuLabel.html#ad1e0f04cc2ec406844a19c266c054d3c">setSource</a> DESIGNABLE <span class="keyword">true</span>)</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="classQuLabel.html#afd19b65988219db05e57cdea4efe99bf">QuLabel</a>(QWidget *w, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a> &amp;r_fac);</div><div class="line"></div><div class="line">    <a class="code" href="classQuLabel.html#afd19b65988219db05e57cdea4efe99bf">QuLabel</a>(QWidget *w, CumbiaPool *cumbia_pool, <span class="keyword">const</span> <a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a> &amp;fpool);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <a class="code" href="classQuLabel.html#a1eceeb2fbd5f65f77e4e3e0dc664fab4">~QuLabel</a>();</div><div class="line"></div><div class="line">    <span class="comment">// CuTangoListener interface</span></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#ac4d740169e8b996ce3fcf4176114eb12">onUpdate</a>(<span class="keyword">const</span> CuData &amp;d);</div><div class="line">    <span class="comment">// CuContextI interface</span></div><div class="line">    <a class="code" href="classCuContext.html">CuContext</a> *<a class="code" href="classQuLabel.html#a6da36dc5ee833bc5fc6effa0092aedf5">getContext</a>() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="comment">// return the source property</span></div><div class="line">    QString <a class="code" href="classQuLabel.html#a4af093529f2c0a67a49491f817ed637a">source</a>() <span class="keyword">const</span>;</div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> slots:</div><div class="line">    <span class="comment">// same method name as QTango&#39;s</span></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#ad1e0f04cc2ec406844a19c266c054d3c">setSource</a>(<span class="keyword">const</span> QString&amp; s);</div><div class="line"></div><div class="line">    <span class="comment">// same method name as QTango&#39;s</span></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#abd504f8f2129310b6fc6fb6e95904bb3">unsetSource</a>();</div><div class="line"></div><div class="line"></div><div class="line">signals:</div><div class="line">    <span class="comment">// convenience signal for users of this class, they can be notified when</span></div><div class="line">    <span class="comment">// new data is available.</span></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#a51ac4e2f0a13c702e1e531524dd8ad35">newData</a>(<span class="keyword">const</span> CuData&amp;);</div><div class="line"></div><div class="line">    <span class="comment">// this signal must be provided in conjunction with contextMenuEvent</span></div><div class="line">    <span class="comment">// in order for the client to be able to</span></div><div class="line">    <span class="comment">// receive statistics and information about the health of the reader.</span></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#aa377bd09299f63a4be8acbb51e0c5f8a">linkStatsRequest</a>(QWidget *myself, <a class="code" href="classCuContextI.html">CuContextI</a> *myself_as_cwi);</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#a6eea2c5dc16ebc8397b56fdb3410cf74">contextMenuEvent</a>(QContextMenuEvent* e);</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="comment">// private pointer (bridge) pattern. See .cpp implementation.</span></div><div class="line">    <span class="comment">// This is a suggested pattern, not compulsory.</span></div><div class="line">    QuLabelPrivate *d;</div><div class="line">};</div></div><!-- fragment --><p>CuDataListener and <a class="el" href="classCuContextI.html" title="Interface for cumbia classes delegating to CuContext the communication link creation and management.">CuContextI</a> are pure interfaces. onUpdate and getContext must be implemented in order to make a <em>label</em> widget a cumbia widget.</p>
<ul>
<li>onUpdate replaces the work that used to be done by the QTango refresh and the configure methods at once. onUpdate's data paramter contains all the information needed to update the reader, such as value, error messages, data type, format and also configuration settings (if the data "type" is "property")</li>
</ul>
<p>Another major change affects the constructor parametrization. The reader is configured at creation time, and must be written to display data in a way that is independent from the underlying engine. In other words, a <a class="el" href="classQuLabel.html" title="A label derived from Qt QLabel to display boolean values, strings, scalars and even vectors.">QuLabel</a> will display a scalar value coming either from Tango or another control system environment.</p>
<p>In the cpp file, a <a class="el" href="classCuContext.html" title="CuLinkControl stores a small set of objects to help create readers and writers.">CuContext</a> must be created and parametrized either with the Cumbia/CuControlsReaderFactoryI pair or the CumbiaPool/CuControlsFactoryPool. All necessary include directives must be specified, as in the example below.</p>
<dl class="section note"><dt>Note</dt><dd>The CumbiaPool / <a class="el" href="classCuControlsFactoryPool.html" title="this class, used in conjunction with CumbiaPool allows to connect to different control system framewo...">CuControlsFactoryPool</a> version allows the reader to be automatically set up with one of the available engines according to the form of the <em>source</em> property. This means that a source named <em>control:ai1</em> will connect to an Epics channel (analog input), while <em>b/power_supply/psdelta/Curren</em> will read the current from a Tango power supply. Engine implementations are registered and set up through the <a class="el" href="classCuControlsFactoryPool.html" title="this class, used in conjunction with CumbiaPool allows to connect to different control system framewo...">CuControlsFactoryPool</a> object.</dd></dl>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="qulabel_8h.html">qulabel.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cucontrolsreader__abs_8h.html">cucontrolsreader_abs.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;cumacros.h&gt;</span>  <span class="comment">// for pinfo, perr, qstoc (qstring to char *)...</span></div><div class="line"><span class="preprocessor">#include &lt;cumbiapool.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cudata.h&gt;</span>  <span class="comment">// exchanged data definition</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cucontrolsfactories__i_8h.html">cucontrolsfactories_i.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cucontrolsfactorypool_8h.html">cucontrolsfactorypool.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="culinkstats_8h.html">culinkstats.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;QContextMenuEvent&gt;</span> <span class="comment">// for the context menu event</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cucontextmenu_8h.html">cucontextmenu.h</a>&gt;</span>   <span class="comment">// for the context menu event</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cucontext_8h.html">cucontext.h</a>&gt;</span> <span class="comment">// the CuContext of a cumbia-qtcontrols object</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>QuLabelPrivate <span class="comment">// use private pointer pattern (&lt;em&gt;bridge&lt;/em&gt;)</span></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="classCuContext.html">CuContext</a> *context;</div><div class="line">    <span class="comment">// ... other attributes here</span></div><div class="line">};</div><div class="line"></div><div class="line"><a class="code" href="classQuLabel.html#afd19b65988219db05e57cdea4efe99bf">QuLabel::QuLabel</a>(QWidget *w, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a> &amp;r_factory) :</div><div class="line">    ESimpleLabel(w), CuDataListener()</div><div class="line">{</div><div class="line">    d = <span class="keyword">new</span> QuLabelPrivate; <span class="comment">// d private pointer. QuLabelPrivate stores class attributes</span></div><div class="line">    d-&gt;context = <span class="keyword">new</span> <a class="code" href="classCuContext.html">CuContext</a>(cumbia, r_factory);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="classQuLabel.html#afd19b65988219db05e57cdea4efe99bf">QuLabel::QuLabel</a>(QWidget *w, CumbiaPool *cumbia_pool, <span class="keyword">const</span> <a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a> &amp;fpool) :</div><div class="line">    ESimpleLabel(w), CuDataListener()</div><div class="line">{</div><div class="line">    d = <span class="keyword">new</span> QuLabelPrivate; <span class="comment">// d private pointer. QuLabelPrivate stores class attributes</span></div><div class="line">    d-&gt;context = <span class="keyword">new</span> <a class="code" href="classCuContext.html">CuContext</a>(cumbia_pool, fpool);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// The label destructor. We delete the context and the private pointer</span></div><div class="line"><a class="code" href="classQuLabel.html#a1eceeb2fbd5f65f77e4e3e0dc664fab4">QuLabel::~QuLabel</a>()</div><div class="line">{</div><div class="line">    <span class="keyword">delete</span> d-&gt;context;</div><div class="line">    <span class="keyword">delete</span> d;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// if the reader has been configured with setSource, get a reference</span></div><div class="line"><span class="comment">// and return the reader&#39;s source. Otherwise return an empty string.</span></div><div class="line">QString <a class="code" href="classQuLabel.html#a4af093529f2c0a67a49491f817ed637a">QuLabel::source</a>()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="classCuControlsReaderA.html">CuControlsReaderA</a>* r = d-&gt;context-&gt;getReader())</div><div class="line">        <span class="keywordflow">return</span> r-&gt;source();</div><div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// initialise the reader with the given source</span></div><div class="line"><span class="comment">// The name of the method is the same used in QTango.</span></div><div class="line"><span class="comment">// Since QuLabel displays the value of only one source at a time, we use the</span></div><div class="line"><span class="comment">// replace_reader method from the context class.</span></div><div class="line"><span class="comment">// replace_reader returns a CuControlsReaderA reference on which setSource must</span></div><div class="line"><span class="comment">// be called</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#ad1e0f04cc2ec406844a19c266c054d3c">QuLabel::setSource</a>(<span class="keyword">const</span> QString &amp;s)</div><div class="line">{</div><div class="line">    <a class="code" href="classCuControlsReaderA.html">CuControlsReaderA</a> * r = d-&gt;context-&gt;replace_reader(s.toStdString(), <span class="keyword">this</span>);</div><div class="line">    <span class="keywordflow">if</span>(r)</div><div class="line">        r-&gt;<a class="code" href="classCuControlsReaderA.html#a47bdc194f2149ed88778d45989e93d47">setSource</a>(s);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// stop reading.</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#abd504f8f2129310b6fc6fb6e95904bb3">QuLabel::unsetSource</a>()</div><div class="line">{</div><div class="line">    d-&gt;context-&gt;disposeReader();</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="classCuContext.html">CuContext</a> *<a class="code" href="classQuLabel.html#a6da36dc5ee833bc5fc6effa0092aedf5">QuLabel::getContext</a>()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">    <span class="keywordflow">return</span> d-&gt;context;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="classQuLabel.html#ac4d740169e8b996ce3fcf4176114eb12">QuLabel::onUpdate</a>(<span class="keyword">const</span> CuData &amp;da)</div><div class="line">{</div><div class="line">    QString txt;</div><div class="line">    QColor background, border;</div><div class="line">    <span class="comment">// check the &quot;err&quot; value on the CuData for errors</span></div><div class="line">    d-&gt;read_ok = !da[<span class="stringliteral">&quot;err&quot;</span>].toBool();</div><div class="line">    setEnabled(d-&gt;read_ok); <span class="comment">// disable widget if there&#39;s a read error</span></div><div class="line"></div><div class="line">    <span class="comment">// update link statistics: increment operation counter on the context&#39;s link statistics</span></div><div class="line">    d-&gt;context-&gt;getLinkStats()-&gt;addOperation();</div><div class="line">    <span class="keywordflow">if</span>(!d-&gt;read_ok) <span class="comment">// add the error on the context&#39;s link statistics</span></div><div class="line">        d-&gt;context-&gt;getLinkStats()-&gt;addError(da[<span class="stringliteral">&quot;msg&quot;</span>].toString());</div><div class="line"></div><div class="line">    <span class="comment">// cumbia-tango implementation provides quality_color and success_color codes.</span></div><div class="line">    <span class="comment">// we can use them to decorate the label accordingly.</span></div><div class="line">    <span class="keywordflow">if</span>(da.containsKey(<span class="stringliteral">&quot;quality_color&quot;</span>))</div><div class="line">        background = d-&gt;palette[QString::fromStdString(da[<span class="stringliteral">&quot;quality_color&quot;</span>].toString())];</div><div class="line">    <span class="keywordflow">if</span>(da.containsKey(<span class="stringliteral">&quot;success_color&quot;</span>))</div><div class="line">        border = d-&gt;palette[QString::fromStdString(da[<span class="stringliteral">&quot;success_color&quot;</span>].toString())];</div><div class="line"></div><div class="line">    <span class="comment">// as we used to do with QTango widgets, set a tooltip with the reader&#39;s message.</span></div><div class="line">    setToolTip(da[<span class="stringliteral">&quot;msg&quot;</span>].toString().c_str());</div><div class="line"></div><div class="line">    <span class="comment">// display &#39;#&#39;s a la QTango in case of error</span></div><div class="line">    <span class="keywordflow">if</span>(da[<span class="stringliteral">&quot;err&quot;</span>].toBool() )</div><div class="line">        setText(<span class="stringliteral">&quot;####&quot;</span>);</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(da.containsKey(<span class="stringliteral">&quot;value&quot;</span>)) <span class="comment">// read ok</span></div><div class="line">    {</div><div class="line">        CuVariant val = da[<span class="stringliteral">&quot;value&quot;</span>];</div><div class="line">        <span class="comment">// if the type of data is boolean, QuLabel, as QTango TLabel, can be configured to display</span></div><div class="line">        <span class="comment">// a special color for the true and false values.</span></div><div class="line">        <span class="keywordflow">if</span>(val.getType() == CuVariant::Boolean)</div><div class="line">        {</div><div class="line">            txt = (val.toBool() ? property(<span class="stringliteral">&quot;trueString&quot;</span>).toBool() : property(<span class="stringliteral">&quot;falseString&quot;</span>).toBool());</div><div class="line">            background = val.toBool() ? property(<span class="stringliteral">&quot;trueColor&quot;</span>).value&lt;QColor&gt;() : property(<span class="stringliteral">&quot;falseColor&quot;</span>).value&lt;QColor&gt;();</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="comment">// convert everything to string.</span></div><div class="line">        {</div><div class="line">            <span class="comment">// CuVariant toString returns a std::string</span></div><div class="line">            txt = QString::fromStdString(da[<span class="stringliteral">&quot;value&quot;</span>].toString());</div><div class="line">        }</div><div class="line">        setText(txt);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// cumbia-tango provides a convenient property for the state color.</span></div><div class="line">    <span class="keywordflow">if</span>(da.containsKey(<span class="stringliteral">&quot;state_color&quot;</span>))</div><div class="line">    {</div><div class="line">        CuVariant v = da[<span class="stringliteral">&quot;state_color&quot;</span>];</div><div class="line">        <a class="code" href="classQuPalette.html">QuPalette</a> p; <span class="comment">// QuPalette associates color names to QColor</span></div><div class="line">        background = p[QString::fromStdString(v.toString())]; <span class="comment">// use color for background</span></div><div class="line">    }</div><div class="line">    decorate(background, border); <span class="comment">// apply colors to label (method not shown in this example)</span></div><div class="line">    emit newData(da); <span class="comment">// clients can be notified</span></div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="Migrating"></a>
QTango readers to cumbia or writing a cumbia reader.</h1>
<p>As in readers, QTango writers derive from multiple base classes. Take the TNumeric widget as an example. It derives from the pure control widget, <a class="el" href="classENumeric.html" title="a widget to set a value">ENumeric</a>, and some more base classes:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>TNumeric : <span class="keyword">public</span> <a class="code" href="classENumeric.html">ENumeric</a>,</div><div class="line">               <span class="keyword">public</span> QTangoComProxyWriter, <span class="keyword">public</span> SimpleDataProxy,</div><div class="line">               <span class="keyword">public</span> QTangoWidgetCommon</div></div><!-- fragment --><ul>
<li>QTangoComProxyWriter is the writer </li>
<li>SimpleDataProxy is an interface that provides the widget contents as a string. In QTango, all writers implement that interface so that the clients are given a string representation of the data to write to Tango. In cumbia we have given up this option in favour of Qt widget's native properties such as text or value, or currentText for QComboBox. </li>
<li>QTangoWidgetCommon provides an implementation for common QTango widgets, such as right click events, link health, copy/paste actions and so on.</li>
</ul>
<p>In analogy with cumbia readers, the writers must define two parametrized constructors and inherit from CuDataListener to receive updates from the link:</p>
<div class="fragment"><div class="line"><span class="preprocessor">   #include &lt;QPushButton&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cudatalistener.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>QuButtonPrivate;</div><div class="line"><span class="keyword">class </span>Cumbia;</div><div class="line"><span class="keyword">class </span>CumbiaPool;</div><div class="line"><span class="keyword">class </span><a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a>;</div><div class="line"><span class="keyword">class </span><a class="code" href="classCuControlsWriterFactoryI.html">CuControlsWriterFactoryI</a>;</div><div class="line"></div><div class="line"><span class="keyword">class </span><a class="code" href="classQuApplyNumeric.html">QuApplyNumeric</a> : <span class="keyword">public</span> <a class="code" href="classEApplyNumeric.html">EApplyNumeric</a>, <span class="keyword">public</span> CuDataListener</div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line">    <span class="comment">// perfect analogy with QTango for the targets property</span></div><div class="line">    Q_PROPERTY(QString targets READ targets WRITE setTargets DESIGNABLE <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="comment">// same as the reader, but use CuControlsWriterFactoryI instead of CuControlsReaderFactoryI</span></div><div class="line">    <a class="code" href="classQuApplyNumeric.html#a54877bd3f6299e64a4bad3118d63f100">QuApplyNumeric</a>(QWidget *parent, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsWriterFactoryI.html">CuControlsWriterFactoryI</a> &amp;w_fac);</div><div class="line">    <span class="comment">// same as the reader.</span></div><div class="line">    <a class="code" href="classQuApplyNumeric.html#a54877bd3f6299e64a4bad3118d63f100">QuApplyNumeric</a>(QWidget *w, CumbiaPool *cumbia_pool, <span class="keyword">const</span> <a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a> &amp;fpool);</div></div><!-- fragment --><p>The cumbia writer will have a destructor, the setTargets and execute slots and the implementation of the onUpdate pure virtual method. This last method is used to configure the limits for the values that can be written by the widget, according to the range of the connected quantity (properties normally available both from Tango and Epics). The onUpdate may in principle be used to receive the result of a write operation.</p>
<dl class="section note"><dt>Note</dt><dd>To provide a contextual menu for the writer, you must follow the same instructions given for the reader, inheriting from <a class="el" href="classCuContextI.html" title="Interface for cumbia classes delegating to CuContext the communication link creation and management.">CuContextI</a> and implementing the contextMenuEvent method and the getContext pure virtual function.</dd></dl>
<div class="fragment"><div class="line">    <span class="keyword">virtual</span> ~<a class="code" href="classQuApplyNumeric.html">QuApplyNumeric</a>();</div><div class="line"></div><div class="line">    QString targets() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="comment">// CuDatListener interface</span></div><div class="line">    <span class="keywordtype">void</span> onUpdate(<span class="keyword">const</span> CuData &amp;d);</div><div class="line"></div><div class="line"><span class="keyword">public</span> slots:</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> setTargets(<span class="keyword">const</span> QString&amp; targets);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> execute(<span class="keywordtype">double</span> val);</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    QuApplyNumericPrivate *d;</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> m_init(;</div></div><!-- fragment --><p>Let's have a look at the implementation within the cpp file. In analogy with the reader, a <a class="el" href="classCuContext.html" title="CuLinkControl stores a small set of objects to help create readers and writers.">CuContext</a> is created. A <em>bridge pattern</em> is used in this example to keep QuNumeric interface separate from implementation and class attributes. Please note a reference to the CuLog object used to log errors. The same approach for error logging can be adopted by a reader.</p>
<div class="fragment"><div class="line"><span class="comment">// necessary includes</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="quapplynumeric_8h.html">quapplynumeric.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;cumacros.h&gt;</span>   <span class="comment">// pinfo pwarn perr qstoc</span></div><div class="line"><span class="preprocessor">#include &lt;cudata.h&gt;</span>     <span class="comment">// exchanged data class definition</span></div><div class="line"><span class="preprocessor">#include &lt;cumbia.h&gt;</span>     <span class="comment">// cumbia</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cucontrolswriter__abs_8h.html">cucontrolswriter_abs.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cucontrolsfactories__i_8h.html">cucontrolsfactories_i.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cucontrolsutils_8h.html">cucontrolsutils.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;cumbiapool.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cucontext_8h.html">cucontext.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="qulogimpl_8h.html">qulogimpl.h</a>&quot;</span></div><div class="line"><span class="comment">// bridge pattern: stores class attributes</span></div><div class="line"><span class="keyword">class </span>QuApplyNumericPrivate</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="classCuContext.html">CuContext</a> *context;</div><div class="line">    <span class="keywordtype">bool</span> auto_configure;</div><div class="line">    <span class="keywordtype">bool</span> write_ok;</div><div class="line">    CuLog *log;</div><div class="line">};</div></div><!-- fragment --><p>The two constructors take advantage of the common initialization performed by m_init. Please note the necessary signal/slot connection within the m_init method to invoke the execute method when the <em>apply</em> button is clicked:</p>
<div class="fragment"><div class="line"><a class="code" href="classQuApplyNumeric.html#a54877bd3f6299e64a4bad3118d63f100">QuApplyNumeric::QuApplyNumeric</a>(QWidget *parent, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsWriterFactoryI.html">CuControlsWriterFactoryI</a> &amp;w_fac)</div><div class="line">    : <a class="code" href="classEApplyNumeric.html">EApplyNumeric</a>(parent)</div><div class="line">{</div><div class="line">    m_init();</div><div class="line">    d-&gt;context = <span class="keyword">new</span> <a class="code" href="classCuContext.html">CuContext</a>(cumbia, w_fac);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="classQuApplyNumeric.html#a54877bd3f6299e64a4bad3118d63f100">QuApplyNumeric::QuApplyNumeric</a>(QWidget *parent, CumbiaPool *cumbia_pool, <span class="keyword">const</span> <a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a> &amp;fpool)</div><div class="line">    : <a class="code" href="classEApplyNumeric.html">EApplyNumeric</a>(parent)</div><div class="line">{</div><div class="line">    m_init();</div><div class="line">    d-&gt;context = <span class="keyword">new</span> <a class="code" href="classCuContext.html">CuContext</a>(cumbia_pool, fpool);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> QuApplyNumeric::m_init()</div><div class="line">{</div><div class="line">    d = <span class="keyword">new</span> QuApplyNumericPrivate; <span class="comment">// allocate the bridge</span></div><div class="line">    connect(<span class="keyword">this</span>, SIGNAL(clicked(<span class="keywordtype">double</span>)), <span class="keyword">this</span>, SLOT(execute(<span class="keywordtype">double</span>)));</div><div class="line">    d-&gt;auto_configure = <span class="keyword">true</span>; <span class="comment">// auto configure option: set limits on the values</span></div><div class="line">    d-&gt;write_ok = <span class="keyword">false</span>;</div><div class="line">}</div></div><!-- fragment --><p> The destructor deletes the context and the private pointer:</p>
<div class="fragment"><div class="line"><a class="code" href="classQuApplyNumeric.html#a5d867fe3942810b4fa64ded24d08a906">QuApplyNumeric::~QuApplyNumeric</a>()</div><div class="line">{</div><div class="line">    <span class="keyword">delete</span> d-&gt;context;</div><div class="line">    <span class="keyword">delete</span> d;</div><div class="line">}</div></div><!-- fragment --><p>The targets and setTargets methods set up the connection that is used to perform the writing later on.</p>
<div class="fragment"><div class="line">QString QuApplyNumeric::targets()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">    <a class="code" href="classCuControlsWriterA.html">CuControlsWriterA</a> *w = d-&gt;context-&gt;getWriter();</div><div class="line">    <span class="keywordflow">if</span>(w != NULL)</div><div class="line">        <span class="keywordflow">return</span> w-&gt;targets(); <span class="comment">// if the writer is configured</span></div><div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>; <span class="comment">// empty string otherwise</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// set up the connection</span></div><div class="line"><span class="keywordtype">void</span> QuApplyNumeric::setTargets(<span class="keyword">const</span> QString &amp;targets)</div><div class="line">{</div><div class="line">    <span class="comment">// only one writer at a time: use replace_writer from CuContext</span></div><div class="line">    <a class="code" href="classCuControlsWriterA.html">CuControlsWriterA</a>* w = d-&gt;context-&gt;replace_writer(targets.toStdString(), <span class="keyword">this</span>);</div><div class="line">    <span class="keywordflow">if</span>(w)</div><div class="line">        w-&gt;setTargets(targets); <span class="comment">// setTargets must be called on a valid writer</span></div><div class="line">}</div></div><!-- fragment --><p>When the user clicks on the OK or Apply button, execute is invoked. </p><ul>
<li>Use <a class="el" href="classCuControlsUtils.html" title="utility class to find input arguments from objects with text or value properties">CuControlsUtils</a> to interpret the targets correctly and pack them into a CuVariant. </li>
<li>use setArgs on the writer to pass the input value to be written </li>
<li>call execute on the writer itself <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="classQuApplyNumeric.html#a3168577ba37902073045506a72383a3c">QuApplyNumeric::execute</a>(<span class="keywordtype">double</span> val)</div><div class="line">{</div><div class="line">    cuprintf(<span class="stringliteral">&quot;QuApplyNumeric.execute\n&quot;</span>);</div><div class="line">    CuVariant args(val);</div><div class="line">    printf(<span class="stringliteral">&quot;QuApplyNumeric.execute: got args %s type %d format %d\n&quot;</span>, args.toString().c_str(), args.getType(),</div><div class="line">           args.getFormat());</div><div class="line">    <a class="code" href="classCuControlsWriterA.html">CuControlsWriterA</a> *w = d-&gt;context-&gt;getWriter();</div><div class="line">    <span class="keywordflow">if</span>(w)</div><div class="line">    {</div><div class="line">        w-&gt;<a class="code" href="classCuControlsWriterA.html#a2485ce84fe04db02feb23117428e8048">setArgs</a>(args);</div><div class="line">        w-&gt;execute();</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
<p>The onUpdate method is used to configure the widget so that the user can write only values within a given range provided by the target. The first lines of the method deal with possible error conditions. The log facility is supplied by a service. A service is registered in a service provider class (CuServiceProvider) handled by Cumbia. So a reference to Cumbia must be obtained first. In the simplest case where the <a class="el" href="classQuApplyNumeric.html" title="A widget to input a number and write it to a target linked to a control system engine.">QuApplyNumeric</a> has been parametrized with a Cumbia reference, just fetch such reference from the <a class="el" href="classCuContext.html#a338be23065febdcd82af20725466d83d">CuContext::cumbiaPool</a> method. If the reference is not availabe, we pick a Cumbia implementation from the CumbiaPool, that will do its best to find one according to the source name.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="classQuApplyNumeric.html#a89b0b60955cae209e361fd21d6351b5e">QuApplyNumeric::onUpdate</a>(<span class="keyword">const</span> CuData &amp;da)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span>(da[<span class="stringliteral">&quot;err&quot;</span>].toBool())</div><div class="line">    {</div><div class="line"></div><div class="line">        Cumbia* cumbia = d-&gt;context-&gt;cumbia();</div><div class="line">        <span class="keywordflow">if</span>(!cumbia) <span class="comment">// pick from the CumbiaPool</span></div><div class="line">            cumbia = d-&gt;context-&gt;cumbiaPool()-&gt;getBySrc(da[<span class="stringliteral">&quot;src&quot;</span>].toString());</div><div class="line">        CuLog *log;</div><div class="line">        <span class="keywordflow">if</span>(cumbia &amp;&amp; (log = static_cast&lt;CuLog *&gt;(cumbia-&gt;getServiceProvider()-&gt;get(CuServices::Log)) )</div><div class="line">        {</div><div class="line">            static_cast&lt;QuLogImpl *&gt;(log-&gt;getImpl(<span class="stringliteral">&quot;QuLogImpl&quot;</span>))-&gt;showPopupOnMessage(CuLog::Write, <span class="keyword">true</span>);</div><div class="line">            log-&gt;write(QString(<span class="stringliteral">&quot;QuApplyNumeric [&quot;</span> + objectName() + <span class="stringliteral">&quot;]&quot;</span>).toStdString(), da[<span class="stringliteral">&quot;msg&quot;</span>].toString(), CuLog::Error, CuLog::Write);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(d-&gt;auto_configure &amp;&amp; da[<span class="stringliteral">&quot;type&quot;</span>].toString() == <span class="stringliteral">&quot;property&quot;</span>)</div><div class="line">    {</div><div class="line">        QString desc = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordflow">if</span>(da[<span class="stringliteral">&quot;data_format_str&quot;</span>] == <span class="stringliteral">&quot;scalar&quot;</span> &amp;&amp; da[<span class="stringliteral">&quot;writable&quot;</span>].toInt() &gt; 0)</div><div class="line">        {</div><div class="line"></div><div class="line">            CuVariant m, M;</div><div class="line">            m = da[<span class="stringliteral">&quot;min&quot;</span>];</div><div class="line">            M = da[<span class="stringliteral">&quot;max&quot;</span>];</div><div class="line">            std::string print_format = da[<span class="stringliteral">&quot;format&quot;</span>].toString();</div><div class="line">            <span class="keywordtype">double</span> min, max;</div><div class="line">            <span class="keywordtype">bool</span> ok;</div><div class="line">            ok = m.to&lt;<span class="keywordtype">double</span>&gt;(min);</div><div class="line">            <span class="keywordflow">if</span>(ok)</div><div class="line">                ok = M.to&lt;<span class="keywordtype">double</span>&gt;(max);</div><div class="line">            <span class="keywordflow">if</span>(ok)</div><div class="line">            {</div><div class="line">                configureNumber(min, min, QString::fromStdString(print_format));</div><div class="line">                <a class="code" href="classEApplyNumeric.html#a8cb864b264cd7d685e3dc7d776028b0f">setIntDigits</a>(<a class="code" href="classEApplyNumeric.html#a059ca12eb7df0c94c756f0a779d10ecb">integerDigits</a>());</div><div class="line">                <a class="code" href="classEApplyNumeric.html#ae8796441613e6d2550562966b43b98bb">setDecDigits</a>(<a class="code" href="classEApplyNumeric.html#a79726dd6c3646b3abdc5a9e9e455f085">decimalDigits</a>());</div><div class="line">                <a class="code" href="classEApplyNumeric.html#a438cad8e42fc581953517eec6e972c53">setMaximum</a>(max);</div><div class="line">                <a class="code" href="classEApplyNumeric.html#a0fd4445efab4d2f6a46d7aa9192ec7b9">setMinimum</a>(min);</div><div class="line">                desc = <span class="stringliteral">&quot;\n(min: &quot;</span>+ QString(<span class="stringliteral">&quot;%1&quot;</span>).arg(min) + <span class="stringliteral">&quot; max: &quot;</span>+ QString(<span class="stringliteral">&quot;%1&quot;</span>).arg(max) + <span class="stringliteral">&quot;)&quot;</span>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">                pinfo(<span class="stringliteral">&quot;QuApplyNumeric: maximum and minimum values not set on the tango attribute \&quot;%s\&quot;, object \&quot;%s\&quot;: &quot;</span></div><div class="line">                      <span class="stringliteral">&quot;not setting format nor maximum/minimum&quot;</span>, qstoc(targets()), qstoc(objectName()));</div><div class="line">            <span class="keywordtype">double</span> val;</div><div class="line">            <span class="keywordtype">bool</span> can_be_double = da[<span class="stringliteral">&quot;w_value&quot;</span>].to&lt;<span class="keywordtype">double</span>&gt;(val);</div><div class="line">            <span class="keywordflow">if</span> (can_be_double)</div><div class="line">            {</div><div class="line">                <a class="code" href="classEApplyNumeric.html#a4591dcec1b250a5fdaeef8c7d2d0cd00">setValue</a>(val);</div><div class="line">                <a class="code" href="classEApplyNumeric.html#a5f9e5437bd0627a91f43f03699ca807c">clearModified</a>();</div><div class="line">            }</div><div class="line">            <span class="keywordflow">if</span>(!da[<span class="stringliteral">&quot;description&quot;</span>].isNull()) {</div><div class="line">                desc.prepend(QString::fromStdString(da[<span class="stringliteral">&quot;description&quot;</span>].toString()));</div><div class="line">            }</div><div class="line">            setWhatsThis(desc);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">            perr(<span class="stringliteral">&quot;QuApplyNumeric [%s]: invalid data format \&quot;%s\&quot; or read only source (writable: %d)&quot;</span>, qstoc(objectName()),</div><div class="line">                 da[<span class="stringliteral">&quot;data_format_str&quot;</span>].toString().c_str(), da[<span class="stringliteral">&quot;writable&quot;</span>].toInt());</div><div class="line"></div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Dec 10 2019 15:46:36 for cumbia-qtcontrols by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
