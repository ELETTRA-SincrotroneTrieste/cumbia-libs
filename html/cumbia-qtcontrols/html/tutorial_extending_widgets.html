<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cumbia-qtcontrols: Writing plugins to add new widgets to &lt;em&gt;cumbia&lt;/em&gt;.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cumbia-qtcontrols
   &#160;<span id="projectnumber">1.x</span>
   </div>
   <div id="projectbrief">Qt widgets on top of the cumbia C++ library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Writing plugins to add new widgets to <em>cumbia</em>. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this tutorial we will learn how to write a plugin exporting a set of widgets that share the same interface as that exposed by the <em>cumbia-qtcontrols</em> elements. A client of the plugin will then instantiate an object and use it as any other <em>cumbia-qtcontrols</em> widget.</p>
<h3>Realtime plot plugin</h3>
<p>A common pattern at <a class="el" href="namespaceElettra.html">Elettra</a> synchrotron is to have Tango devices exposing commands with two input arguments that retur arrays of data. They are usually read with a frequency of 10Hz. The first argument specifies the <em>mode</em>, the second the number of desired elements. The mode is usually fixed and decided by the programmer, but the user may want to change the reading frequency and the number of elements. The plugin will extend <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> and provide the controls to operate this changes. They are offered by an action added to the right click context menu.</p>
<h4>1. Write the widget code</h4>
<p>First, we start writing the code for the widget. The RTPlot <em>is a</em> <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> and inherits from the <a class="el" href="classQuXtraWidgetI.html" title="QuXtraWidgetI defines an interface for widgets created by an implementation of QuXtraWidgetPluginI.">QuXtraWidgetI</a> interface:</p>
<div class="fragment"><div class="line">#include &lt;quspectrumplot.h&gt;</div><div class="line">#include &lt;cudata.h&gt;</div><div class="line">#include &lt;cudatalistener.h&gt;</div><div class="line">#include &lt;quxtrawidgetplugininterface.h&gt;</div><div class="line"></div><div class="line">class Cumbia;</div><div class="line">class CuControlsReaderFactoryI;</div><div class="line"></div><div class="line">class QuRTPlot2 : public QuSpectrumPlot, public QuXtraWidgetI</div><div class="line">{</div><div class="line">public:</div><div class="line">    Q_OBJECT</div><div class="line">    QuRTPlot2(QWidget *parent, Cumbia *cumbia, const CuControlsReaderFactoryI &amp;r_fac);</div><div class="line">    QuRTPlot2(QWidget *parent, CumbiaPool *cumbia_pool, const CuControlsFactoryPool &amp;fpool);</div><div class="line"></div><div class="line">    ~QuRTPlot2();</div><div class="line">    </div><div class="line">    // QuXtraWidgetI interface</div><div class="line">public:</div><div class="line">    CuContext *getContext() const;</div><div class="line">    QString link() const;</div><div class="line">    void setLink(const QString &amp;s);</div><div class="line">    void unsetLink();</div><div class="line">    Type getType() const;</div><div class="line">};</div></div><!-- fragment --><p>The QuRTPlot constructor takes the same input arguments as the <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a>, so that the implementation is simple (example for the first constructor only). Enable Y axis auto scaling by default:</p>
<div class="fragment"><div class="line">QuRTPlot2::QuRTPlot2(QWidget *parent, Cumbia *cumbia, const CuControlsReaderFactoryI &amp;r_fac)</div><div class="line"> : QuSpectrumPlot (parent, cumbia, r_fac)  {</div><div class="line">    setYAxisAutoscaleEnabled(true);</div><div class="line">}</div></div><!-- fragment --><p>The other methods that must be implemented from the <a class="el" href="classQuXtraWidgetI.html" title="QuXtraWidgetI defines an interface for widgets created by an implementation of QuXtraWidgetPluginI.">QuXtraWidgetI</a> interface are very easy to write:</p>
<div class="fragment"><div class="line">CuContext *QuRTPlot2::getContext() const {</div><div class="line">    return QuSpectrumPlot::getContext();</div><div class="line">}</div><div class="line"></div><div class="line">QString QuRTPlot2::link() const {</div><div class="line">    return QuSpectrumPlot::source();</div><div class="line">}</div><div class="line"></div><div class="line">void QuRTPlot2::setLink(const QString &amp;s) {</div><div class="line">    QuSpectrumPlot::setSource(s);</div><div class="line">}</div><div class="line"></div><div class="line">void QuRTPlot2::unsetLink() {</div><div class="line">    QuSpectrumPlot::unsetSource(QString());</div><div class="line">}</div><div class="line"></div><div class="line">QuXtraWidgetI::Type QuRTPlot2::getType() const {</div><div class="line">    return  QuXtraWidgetI::Reader;</div><div class="line">}</div></div><!-- fragment --><p>If we want to allow setting multiple sources through a list of strings, as <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> does, we can provide a convenient <em>Qt property</em> in order to let the clients of QuRTPlot2 access the <em>setSources</em> and <em>sources</em> methods without need for <em>dynamic_cast</em> at runtime:</p>
<div class="fragment"><div class="line">class QuRTPlot2 : public QuSpectrumPlot, public QuXtraWidgetI</div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line">    Q_PROPERTY(QStringList sources READ sources WRITE setSources)</div><div class="line"></div><div class="line">    // ...</div><div class="line">      QStringList sources() const;</div><div class="line"></div><div class="line">public slots:</div><div class="line">    void setSources(const QStringList&amp; srcs);</div><div class="line">   // ...</div><div class="line">}</div></div><!-- fragment --><p>The two added methods are just shortcuts calling the base class equivalents:</p>
<div class="fragment"><div class="line">QStringList QuRTPlot2::sources() const {</div><div class="line">    return QuSpectrumPlot::sources();</div><div class="line">}</div><div class="line"></div><div class="line">void QuRTPlot2::setSources(const QStringList &amp;srcs) {</div><div class="line">    QuSpectrumPlot::setSources(srcs);</div><div class="line">}</div></div><!-- fragment --><p>A dialog will provide options to change the period and the number of samples. It is accessible through the contextual menu. We must reimplement <em>contextMenuEvent</em> and extend the menu with a proper action. <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a>, as well as <a class="el" href="classQuTrendPlot.html" title="Draw a line for each data source over time.">QuTrendPlot</a>, use the <em>strategy</em> pattern to create contextual menus. Get the <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> <em>context menu stragegy</em>, let it create the menu and extend it with a new action:</p>
<div class="fragment"><div class="line">protected:</div><div class="line">    void contextMenuEvent(QContextMenuEvent *e);</div></div><!-- fragment --><p>Implementation: </p><div class="fragment"><div class="line">#include &lt;QMenu&gt;</div><div class="line">// ...</div><div class="line"></div><div class="line">void QuRTPlot2::contextMenuEvent(QContextMenuEvent *e) {</div><div class="line">    QMenu *menu = contextMenuStrategy()-&gt;createMenu(this);</div><div class="line">    menu-&gt;addAction(&quot;Configure real time plot...&quot;, this, SLOT(configureRT()));</div><div class="line">    menu-&gt;exec(QCursor::pos());</div><div class="line">}</div></div><!-- fragment --><p>A configureRT() <em>slot</em> must be added. It creates a <em>dialog</em> with the necessary controls to change the period and the number of samples. Since <em><a class="el" href="namespaceElettra.html">Elettra</a></em> "*real time*" data is acquired through <em>Tango</em> commands with two input arguments and the syntax of the <em>source</em> is like</p>
<div class="fragment"><div class="line">&quot;bc01/diagnostics/rtcm_bc01.01-&gt;GetCharge(0,1000)&quot;</div></div><!-- fragment --><p>a <em>regular expression</em> is employed to replace the old source with the new one. Other implementations are possible. A <em>QDialog</em> is populated with two *QLabel*s, two *QSpinBox*es and two *QPushButton*s.</p>
<div class="fragment"><div class="line">void QuRTPlot2::configureRT() {</div><div class="line">    QDialog d(this);</div><div class="line">    QGridLayout *lo = new QGridLayout(&amp;d);</div><div class="line">    lo-&gt;setMargin(3);</div><div class="line">    lo-&gt;setSpacing(lo-&gt;spacing() / 3);</div><div class="line">    QLabel *lperiod = new QLabel(&quot;Period&quot;, &amp;d);</div><div class="line">    lperiod-&gt;setAlignment(Qt::AlignRight|Qt::AlignVCenter);</div><div class="line">    QLabel *lnsam = new QLabel(&quot;Number of samples&quot;, &amp;d);</div><div class="line">    lnsam-&gt;setAlignment(Qt::AlignRight|Qt::AlignVCenter);</div><div class="line">    QSpinBox *sbperiod = new QSpinBox(&amp;d);</div><div class="line">    sbperiod-&gt;setMinimum(10);</div><div class="line">    sbperiod-&gt;setMaximum(10000);</div><div class="line">    sbperiod-&gt;setValue(100);</div><div class="line">    sbperiod-&gt;setSuffix(&quot;ms&quot;);</div><div class="line">    sbperiod-&gt;setObjectName(&quot;sbperiod&quot;);</div><div class="line">    QSpinBox *sbSamples = new QSpinBox (&amp;d);</div><div class="line">    sbSamples-&gt;setMinimum(10);</div><div class="line">    sbSamples-&gt;setMaximum(1000000);</div><div class="line">    sbSamples-&gt;setValue(1000);</div><div class="line">    sbSamples-&gt;setObjectName(&quot;sbnsam&quot;);</div><div class="line"></div><div class="line">    lo-&gt;addWidget(lperiod, 0, 0, 1, 2);</div><div class="line">    lo-&gt;addWidget(sbperiod, 0, 2, 1, 2);</div><div class="line">    lo-&gt;addWidget(lnsam, 0, 4, 1, 2);</div><div class="line">    lo-&gt;addWidget(sbSamples, 0, 6, 1, 2);</div><div class="line"></div><div class="line">    QPushButton *pbClose = new QPushButton(&quot;Close&quot;, &amp;d);</div><div class="line">    pbClose-&gt;setObjectName(&quot;pbClose&quot;);</div><div class="line">    connect(pbClose, SIGNAL(clicked()), &amp;d, SLOT(reject()));</div><div class="line">    lo-&gt;addWidget(pbClose, 1, 0, 1, 1);</div><div class="line">    QPushButton *pbApply = new QPushButton(&quot;Apply&quot;, &amp;d);</div><div class="line">    pbApply-&gt;setObjectName(&quot;pbApply&quot;);</div><div class="line">    lo-&gt;addWidget(pbApply, 1, 7, 1, 1);</div><div class="line">    connect(pbApply, SIGNAL(clicked()), &amp;d, SLOT(accept()));</div><div class="line"></div><div class="line">    if(d.exec() == QDialog::Accepted) {</div><div class="line">        int timeout = sbperiod-&gt;value();</div><div class="line">        int nsam = sbSamples-&gt;value();</div><div class="line">        QStringList srcs;</div><div class="line">        if(timeout != period())</div><div class="line">            setPeriod(timeout);</div><div class="line">        foreach(QString s, sources()) {</div><div class="line">            QRegExp cmdRe(&quot;(.*)\\((\\d+),(\\d+)\\)&quot;);</div><div class="line">            if(cmdRe.indexIn(s) &gt; -1 &amp;&amp; cmdRe.capturedTexts().size() &gt; 3) {</div><div class="line">                QStringList caps = cmdRe.capturedTexts();</div><div class="line">                QString newSrc = QString(&quot;%1(%2,%3)&quot;).arg(caps[1]).arg(caps[2]).arg(nsam);</div><div class="line">                srcs &lt;&lt; newSrc;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        if(!srcs.isEmpty() &amp;&amp; srcs != sources())</div><div class="line">            setSources(srcs);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Sep 13 2019 09:33:11 for cumbia-qtcontrols by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
