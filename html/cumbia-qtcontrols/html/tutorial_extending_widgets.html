<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cumbia-qtcontrols: Writing plugins to add new widgets to &lt;em&gt;cumbia&lt;/em&gt;.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cumbia-qtcontrols
   &#160;<span id="projectnumber">1.x</span>
   </div>
   <div id="projectbrief">Qt widgets on top of the cumbia C++ library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Writing plugins to add new widgets to <em>cumbia</em>. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this tutorial we will learn how to write a plugin exporting a set of widgets that share the same interface as that exposed by the <em>cumbia-qtcontrols</em> elements. A client of the plugin will then instantiate an object and use it as any other <em>cumbia-qtcontrols</em> widget.</p>
<h2>Realtime plot plugin</h2>
<p>A common pattern at <a class="el" href="namespaceElettra.html">Elettra</a> synchrotron is to have Tango devices exposing commands with two input arguments that retur arrays of data. They are usually read with a frequency of 10Hz. The first argument specifies the <em>mode</em>, the second the number of desired elements. The mode is usually fixed and decided by the programmer, but the user may want to change the reading frequency and the number of elements. The plugin will extend <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> and provide the controls to operate this changes. They are offered by an action added to the right click context menu.</p>
<h3>1. Write the widget code</h3>
<p>First, we start writing the code for the widget. The RTPlot <em>is a</em> <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> and inherits from the <a class="el" href="classQuXtraWidgetI.html" title="QuXtraWidgetI defines an interface for widgets created by an implementation of QuXtraWidgetPluginI.">QuXtraWidgetI</a> interface:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quspectrumplot_8h.html">quspectrumplot.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cudata.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cudatalistener.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quxtrawidgetplugininterface_8h.html">quxtrawidgetplugininterface.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>Cumbia;</div><div class="line"><span class="keyword">class </span><a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a>;</div><div class="line"></div><div class="line"><span class="keyword">class </span>QuRTPlot2 : <span class="keyword">public</span> <a class="code" href="classQuSpectrumPlot.html">QuSpectrumPlot</a>, <span class="keyword">public</span> <a class="code" href="classQuXtraWidgetI.html">QuXtraWidgetI</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Q_OBJECT</div><div class="line">    QuRTPlot2(QWidget *parent, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a> &amp;r_fac);</div><div class="line">    QuRTPlot2(QWidget *parent, CumbiaPool *cumbia_pool, <span class="keyword">const</span> <a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a> &amp;fpool);</div><div class="line"></div><div class="line">    ~QuRTPlot2();</div><div class="line">    </div><div class="line">    <span class="comment">// QuXtraWidgetI interface</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="classCuContext.html">CuContext</a> *<a class="code" href="classQuSpectrumPlot.html#a523e3e9607f4cf8ae5c0b6664667c845">getContext</a>() <span class="keyword">const</span>;</div><div class="line">    QString <a class="code" href="classQuXtraWidgetI.html#a23de4e4e23d7c43a3bf4040b374d171a">link</a>() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuXtraWidgetI.html#af77a1ddf18d43d96b4dc2a1d56d63358">setLink</a>(<span class="keyword">const</span> QString &amp;s);</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuXtraWidgetI.html#a364a4da6dda2571445883fa98991213e">unsetLink</a>();</div><div class="line">    Type <a class="code" href="classQuXtraWidgetI.html#ae84824473dc1b6fd1374a085ea5df003">getType</a>() <span class="keyword">const</span>;</div><div class="line">};</div></div><!-- fragment --><p>The QuRTPlot constructor takes the same input arguments as the <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a>, so that the implementation is simple (example for the first constructor only). Enable Y axis auto scaling by default:</p>
<div class="fragment"><div class="line">QuRTPlot2::QuRTPlot2(QWidget *parent, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a> &amp;r_fac)</div><div class="line"> : <a class="code" href="classQuSpectrumPlot.html">QuSpectrumPlot</a> (parent, cumbia, r_fac)  {</div><div class="line">    setYAxisAutoscaleEnabled(<span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><p>The other methods that must be implemented from the <a class="el" href="classQuXtraWidgetI.html" title="QuXtraWidgetI defines an interface for widgets created by an implementation of QuXtraWidgetPluginI.">QuXtraWidgetI</a> interface are very easy to write:</p>
<div class="fragment"><div class="line"><a class="code" href="classCuContext.html">CuContext</a> *QuRTPlot2::getContext()<span class="keyword"> const </span>{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classQuSpectrumPlot.html#a523e3e9607f4cf8ae5c0b6664667c845">QuSpectrumPlot::getContext</a>();</div><div class="line">}</div><div class="line"></div><div class="line">QString QuRTPlot2::link()<span class="keyword"> const </span>{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classQuSpectrumPlot.html#ac5f37febcb659987c7f68f4e8414c5ae">QuSpectrumPlot::source</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> QuRTPlot2::setLink(<span class="keyword">const</span> QString &amp;s) {</div><div class="line">    <a class="code" href="classQuSpectrumPlot.html#aea3f116b69a5853349fe92f1d6e0aa84">QuSpectrumPlot::setSource</a>(s);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> QuRTPlot2::unsetLink() {</div><div class="line">    <a class="code" href="classQuSpectrumPlot.html#a7a9d4511f43f1d40df354e1d9fa13a01">QuSpectrumPlot::unsetSource</a>(QString());</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="classQuXtraWidgetI.html#afee1bb2798616d95d40d95efd47c9f00">QuXtraWidgetI::Type</a> QuRTPlot2::getType()<span class="keyword"> const </span>{</div><div class="line">    <span class="keywordflow">return</span>  <a class="code" href="classQuXtraWidgetI.html#afee1bb2798616d95d40d95efd47c9f00a66ed0b53e3b2d649970760e05b832380">QuXtraWidgetI::Reader</a>;</div><div class="line">}</div></div><!-- fragment --><p>If we want to allow setting multiple sources through a list of strings, as <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> does, we can provide a convenient <em>Qt property</em> in order to let the clients of QuRTPlot2 access the <em>setSources</em> and <em>sources</em> methods without need for <em>dynamic_cast</em> at runtime:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>QuRTPlot2 : <span class="keyword">public</span> <a class="code" href="classQuSpectrumPlot.html">QuSpectrumPlot</a>, <span class="keyword">public</span> <a class="code" href="classQuXtraWidgetI.html">QuXtraWidgetI</a></div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line">    Q_PROPERTY(QStringList sources READ sources WRITE setSources)</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">      QStringList <a class="code" href="classQuSpectrumPlot.html#af7450e4a9495da11caeb127d25906d8f">sources</a>() <span class="keyword">const</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> slots:</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classQuSpectrumPlot.html#acd34e11f7c0019da4175e4109767f879">setSources</a>(<span class="keyword">const</span> QStringList&amp; srcs);</div><div class="line">   <span class="comment">// ...</span></div><div class="line">}</div></div><!-- fragment --><p>The two added methods are just shortcuts calling the base class equivalents:</p>
<div class="fragment"><div class="line">QStringList QuRTPlot2::sources()<span class="keyword"> const </span>{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classQuSpectrumPlot.html#af7450e4a9495da11caeb127d25906d8f">QuSpectrumPlot::sources</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> QuRTPlot2::setSources(<span class="keyword">const</span> QStringList &amp;srcs) {</div><div class="line">    <a class="code" href="classQuSpectrumPlot.html#acd34e11f7c0019da4175e4109767f879">QuSpectrumPlot::setSources</a>(srcs);</div><div class="line">}</div></div><!-- fragment --><p>A dialog will provide options to change the period and the number of samples. It is accessible through the contextual menu. We must reimplement <em>contextMenuEvent</em> and extend the menu with a proper action. <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a>, as well as <a class="el" href="classQuTrendPlot.html" title="Draw a line for each data source over time.">QuTrendPlot</a>, use the <em>strategy</em> pattern to create contextual menus. Get the <a class="el" href="classQuSpectrumPlot.html" title="Draw a line for each data source over time.">QuSpectrumPlot</a> <em>context menu stragegy</em>, let it create the menu and extend it with a new action:</p>
<div class="fragment"><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="keywordtype">void</span> contextMenuEvent(QContextMenuEvent *e);</div></div><!-- fragment --><p>Implementation: </p><div class="fragment"><div class="line">#include &lt;QMenu&gt;</div><div class="line">// ...</div><div class="line"></div><div class="line">void QuRTPlot2::contextMenuEvent(QContextMenuEvent *e) {</div><div class="line">    QMenu *menu = contextMenuStrategy()-&gt;createMenu(this);</div><div class="line">    menu-&gt;addAction(&quot;Configure real time plot...&quot;, this, SLOT(configureRT()));</div><div class="line">    menu-&gt;exec(QCursor::pos());</div><div class="line">}</div></div><!-- fragment --><p>A configureRT() <em>slot</em> must be added. It creates a <em>dialog</em> with the necessary controls to change the period and the number of samples. Since <em><a class="el" href="namespaceElettra.html">Elettra</a></em> "*real time*" data is acquired through <em>Tango</em> commands with two input arguments and the syntax of the <em>source</em> is like</p>
<div class="fragment"><div class="line"><span class="stringliteral">&quot;bc01/diagnostics/rtcm_bc01.01-&gt;GetCharge(0,1000)&quot;</span></div></div><!-- fragment --><p>a <em>regular expression</em> is employed to replace the old source with the new one. Other implementations are possible. A <em>QDialog</em> is populated with two *QLabel*s, two *QSpinBox*es and two *QPushButton*s.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> QuRTPlot2::configureRT() {</div><div class="line">    QDialog d(<span class="keyword">this</span>);</div><div class="line">    QGridLayout *lo = <span class="keyword">new</span> QGridLayout(&amp;d);</div><div class="line">    lo-&gt;setMargin(3);</div><div class="line">    lo-&gt;setSpacing(lo-&gt;spacing() / 3);</div><div class="line">    QLabel *lperiod = <span class="keyword">new</span> QLabel(<span class="stringliteral">&quot;Period&quot;</span>, &amp;d);</div><div class="line">    lperiod-&gt;setAlignment(Qt::AlignRight|Qt::AlignVCenter);</div><div class="line">    QLabel *lnsam = <span class="keyword">new</span> QLabel(<span class="stringliteral">&quot;Number of samples&quot;</span>, &amp;d);</div><div class="line">    lnsam-&gt;setAlignment(Qt::AlignRight|Qt::AlignVCenter);</div><div class="line">    QSpinBox *sbperiod = <span class="keyword">new</span> QSpinBox(&amp;d);</div><div class="line">    sbperiod-&gt;setMinimum(10);</div><div class="line">    sbperiod-&gt;setMaximum(10000);</div><div class="line">    sbperiod-&gt;setValue(100);</div><div class="line">    sbperiod-&gt;setSuffix(<span class="stringliteral">&quot;ms&quot;</span>);</div><div class="line">    sbperiod-&gt;setObjectName(<span class="stringliteral">&quot;sbperiod&quot;</span>);</div><div class="line">    QSpinBox *sbSamples = <span class="keyword">new</span> QSpinBox (&amp;d);</div><div class="line">    sbSamples-&gt;setMinimum(10);</div><div class="line">    sbSamples-&gt;setMaximum(1000000);</div><div class="line">    sbSamples-&gt;setValue(1000);</div><div class="line">    sbSamples-&gt;setObjectName(<span class="stringliteral">&quot;sbnsam&quot;</span>);</div><div class="line"></div><div class="line">    lo-&gt;addWidget(lperiod, 0, 0, 1, 2);</div><div class="line">    lo-&gt;addWidget(sbperiod, 0, 2, 1, 2);</div><div class="line">    lo-&gt;addWidget(lnsam, 0, 4, 1, 2);</div><div class="line">    lo-&gt;addWidget(sbSamples, 0, 6, 1, 2);</div><div class="line"></div><div class="line">    QPushButton *pbClose = <span class="keyword">new</span> QPushButton(<span class="stringliteral">&quot;Close&quot;</span>, &amp;d);</div><div class="line">    pbClose-&gt;setObjectName(<span class="stringliteral">&quot;pbClose&quot;</span>);</div><div class="line">    connect(pbClose, SIGNAL(clicked()), &amp;d, SLOT(reject()));</div><div class="line">    lo-&gt;addWidget(pbClose, 1, 0, 1, 1);</div><div class="line">    QPushButton *pbApply = <span class="keyword">new</span> QPushButton(<span class="stringliteral">&quot;Apply&quot;</span>, &amp;d);</div><div class="line">    pbApply-&gt;setObjectName(<span class="stringliteral">&quot;pbApply&quot;</span>);</div><div class="line">    lo-&gt;addWidget(pbApply, 1, 7, 1, 1);</div><div class="line">    connect(pbApply, SIGNAL(clicked()), &amp;d, SLOT(accept()));</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(d.exec() == QDialog::Accepted) {</div><div class="line">        <span class="keywordtype">int</span> timeout = sbperiod-&gt;value();</div><div class="line">        <span class="keywordtype">int</span> nsam = sbSamples-&gt;value();</div><div class="line">        QStringList srcs;</div><div class="line">        <span class="keywordflow">if</span>(timeout != period())</div><div class="line">            setPeriod(timeout);</div><div class="line">        <span class="keywordflow">foreach</span>(QString s, sources()) {</div><div class="line">            QRegExp cmdRe(<span class="stringliteral">&quot;(.*)\\((\\d+),(\\d+)\\)&quot;</span>);</div><div class="line">            <span class="keywordflow">if</span>(cmdRe.indexIn(s) &gt; -1 &amp;&amp; cmdRe.capturedTexts().size() &gt; 3) {</div><div class="line">                QStringList caps = cmdRe.capturedTexts();</div><div class="line">                QString newSrc = QString(<span class="stringliteral">&quot;%1(%2,%3)&quot;</span>).arg(caps[1]).arg(caps[2]).arg(nsam);</div><div class="line">                srcs &lt;&lt; newSrc;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(!srcs.isEmpty() &amp;&amp; srcs != sources())</div><div class="line">            setSources(srcs);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>The widget is now ready. The context menu on the plot allows to configure the new <em>real time plot</em>. In the next section, we have to write the <em>plugin</em> code.</p>
<h3>2. The plugin code</h3>
<p>In order to be loaded as an <em>extra widget plugin</em>, the name of the plugin must meet the requirements discussed in the <a class="el" href="classQuXtraWidgetPluginLoader.html" title="The QuXtraWidgetPluginLoader class finds the plugin that exports a widget with a given file name.">QuXtraWidgetPluginLoader</a> documentation.</p>
<ul>
<li><em>somename-xwidgetplugin.so</em></li>
</ul>
<p>is an example of valid name. We choose <em>elettra.eu.realtimeplot-xwidgetplugin</em> for this example.</p>
<h3>2a. The Qt project file</h3>
<p>In the project file, we <em>include</em> <em>cumbia-qtcontrols.pri</em> project include file to ensure the plugin can see the necessary include files and can link to <em>cumbia-qtcontrols</em> library. We install the plugin under <em>$${INSTALL_ROOT}/include/qumbia-plugins</em> and alongside the plugin library we distribute <em>qurtplot2.h</em> so that clients can access its functions, if needed. A good practise is to define <em>Qt properties (Q_PROPERTY)</em> to access plugin widget properties instead (this avoids <em>dynamic_cast</em>).</p>
<div class="fragment"><div class="line">include(/usr/local/cumbia-libs/include/cumbia-qtcontrols/cumbia-qtcontrols.pri)</div><div class="line"></div><div class="line">QT       += core gui</div><div class="line"></div><div class="line">TARGET = elettra.eu.realtimeplot-xwidgetplugin</div><div class="line">TEMPLATE = lib</div><div class="line">CONFIG += plugin</div><div class="line"></div><div class="line">SOURCES += \</div><div class="line">        src/elettra.eu.realtimeplot-xwidgetplugin.cpp \</div><div class="line">    src/qurtplot2.cpp</div><div class="line"></div><div class="line">HEADERS += \</div><div class="line">        src/elettra.eu.realtimeplot-xwidgetplugin.h \</div><div class="line">    src/qurtplot2.h</div><div class="line"></div><div class="line">INC_PATH = $${INSTALL_ROOT}/include/qumbia-plugins</div><div class="line">inc.files = src/qurtplot2.h</div><div class="line">inc.path = $${INC_PATH}</div><div class="line"></div><div class="line">DISTFILES += elettra.eu.realtimeplot-xwidgetplugin.json</div><div class="line"></div><div class="line">unix {</div><div class="line">    target.path = $${DEFINES_CUMBIA_QTCONTROLS_PLUGIN_DIR}</div><div class="line">    INSTALLS += target inc</div><div class="line">}</div><div class="line"></div><div class="line">message(<span class="stringliteral">&quot;elettra.eu.realtimeplot-xwidgetplugin: plugin installation dir:  $${DEFINES_CUMBIA_QTCONTROLS_PLUGIN_DIR}&quot;</span>)</div><div class="line">message(&quot;elettra.eu.realtimeplot-xwidgetplugin: include installation dir: $${INC_PATH}<span class="stringliteral">&quot;)</span></div></div><!-- fragment --><h3>2b. The plugin files</h3>
<p>The header file, named elettra.eu.realtimeplot-xwidgetplugin.h, contains the <em>RTPlotXWidgetPlugin</em> class, implementing the <a class="el" href="classQuXtraWidgetPluginI.html" title="QuXtraWidgetPluginI provides and interface that subclasses will use to provide one or more widgets ab...">QuXtraWidgetPluginI</a> interface from <em>cumbia-qtcontrols</em> <a class="el" href="quxtrawidgetplugininterface_8h.html">quxtrawidgetplugininterface.h</a>. As you can see, the code is very easy to write. With <em>qtcreator</em>, once defined the class</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>RTPlotXWidgetPlugin : <span class="keyword">public</span> QObject, <span class="keyword">public</span> <a class="code" href="classQuXtraWidgetPluginI.html">QuXtraWidgetPluginI</a></div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line">    Q_PLUGIN_METADATA(IID <span class="stringliteral">&quot;org.qt-project.Qt.QGenericPluginFactoryInterface&quot;</span> FILE <span class="stringliteral">&quot;elettra.eu.realtimeplot-xwidgetplugin.json&quot;</span>)</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">explicit</span> RTPlotXWidgetPlugin(QObject *parent = <span class="keyword">nullptr</span>);</div><div class="line">    ~RTPlotXWidgetPlugin();</div><div class="line"></div><div class="line">    Q_INTERFACES(<a class="code" href="classQuXtraWidgetPluginI.html">QuXtraWidgetPluginI</a>)</div><div class="line">};</div></div><!-- fragment --><p>right click on the class name, <em>RTPlotXWidgetPlugin</em>, and choose <em>Refactor</em> --&gt; <em>Insert Virtual Functions of Base Classes</em> to get the skeleton of the method definitions (in .h file) and implementation (in .cpp file):</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef RTPLOTXWIDGETPLUGIN_H</span></div><div class="line"><span class="preprocessor">#define RTPLOTXWIDGETPLUGIN_H</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quxtrawidgetplugininterface_8h.html">quxtrawidgetplugininterface.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;QObject&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>RTPlotXWidgetPlugin : <span class="keyword">public</span> QObject, <span class="keyword">public</span> <a class="code" href="classQuXtraWidgetPluginI.html">QuXtraWidgetPluginI</a></div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line">    Q_PLUGIN_METADATA(IID <span class="stringliteral">&quot;org.qt-project.Qt.QGenericPluginFactoryInterface&quot;</span> FILE <span class="stringliteral">&quot;elettra.eu.realtimeplot-xwidgetplugin.json&quot;</span>)</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">explicit</span> RTPlotXWidgetPlugin(QObject *parent = <span class="keyword">nullptr</span>);</div><div class="line">    ~RTPlotXWidgetPlugin();</div><div class="line"></div><div class="line">    Q_INTERFACES(<a class="code" href="classQuXtraWidgetPluginI.html">QuXtraWidgetPluginI</a>)</div><div class="line"></div><div class="line">    <span class="comment">// QuXtraWidgetPluginI interface</span></div><div class="line">    QWidget *<a class="code" href="classQuXtraWidgetPluginI.html#a670bbabc0bb6f3df90c22a851afe6b51">create</a>(<span class="keyword">const</span> QString &amp;name, QWidget *parent, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a> &amp;r_fac);</div><div class="line">    QWidget *<a class="code" href="classQuXtraWidgetPluginI.html#a670bbabc0bb6f3df90c22a851afe6b51">create</a>(<span class="keyword">const</span> QString &amp;name, QWidget *parent, CumbiaPool *cumbia_pool, <span class="keyword">const</span> <a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a> &amp;fpool);</div><div class="line">    QString <a class="code" href="classQuXtraWidgetPluginI.html#ac3b64ae702ad43f1cd181ec1286938c4">name</a>() <span class="keyword">const</span>;</div><div class="line">    QStringList <a class="code" href="classQuXtraWidgetPluginI.html#a937e1407235c2bca748e335a63cb04e2">catalogue</a>() <span class="keyword">const</span>;</div><div class="line">};</div></div><!-- fragment --><p>The key methods to implement are the two <em>create</em> ones: according to the given class name, they instantiate one of the objects available in the plugin <em>catalogue</em>. In this example plugin, only <em>QuRTPlot2</em> widget is offered. In the real <em>elettra.eu.realtimeplot-xwidgetplugin</em>, another version of plot is provided.</p>
<div class="fragment"><div class="line"><span class="comment">// include files</span></div><div class="line"><span class="preprocessor">#include &quot;elettra.eu.realtimeplot-xwidgetplugin.h&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cucontrolsreader__abs_8h.html">cucontrolsreader_abs.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cucontext_8h.html">cucontext.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;qurtplot.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;qurtplot2.h&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;cumacros.h&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// create methods</span></div><div class="line"><span class="comment">//</span></div><div class="line">QWidget *RTPlotXWidgetPlugin::create(<span class="keyword">const</span> QString &amp;name, QWidget *parent, Cumbia *cumbia, <span class="keyword">const</span> <a class="code" href="classCuControlsReaderFactoryI.html">CuControlsReaderFactoryI</a> &amp;r_fac)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span>(name == <span class="stringliteral">&quot;QuRTPlot2&quot;</span>)</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">new</span> QuRTPlot2(parent, cumbia, r_fac);</div><div class="line">    perr(<span class="stringliteral">&quot;RTPlotXWidgetPlugin.create: RTPlotXWidgetPlugin does not provide the widget \&quot;%s\&quot;&quot;</span>, qstoc(name));</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div><div class="line">}</div><div class="line"></div><div class="line">QWidget *RTPlotXWidgetPlugin::create(<span class="keyword">const</span> QString &amp;name, QWidget *parent, CumbiaPool *cumbia_pool,</div><div class="line">                                                <span class="keyword">const</span> <a class="code" href="classCuControlsFactoryPool.html">CuControlsFactoryPool</a> &amp;fpool)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span>(name == <span class="stringliteral">&quot;QuRTPlot2&quot;</span>)</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">new</span> QuRTPlot2(parent, cumbia_pool, fpool);</div><div class="line">    perr(<span class="stringliteral">&quot;RTPlotXWidgetPlugin.create: RTPlotXWidgetPlugin does not provide the widget \&quot;%s\&quot;&quot;</span>, qstoc(name));</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div><div class="line">}</div></div><!-- fragment --><p>A <em>catalogue</em> method is required by the plugin interface in order to provide the list of classes (widgets) provided by the plugin. In this example, only one widget is offered:</p>
<div class="fragment"><div class="line">QStringList RTPlotXWidgetPlugin::catalogue()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">    <span class="keywordflow">return</span> QStringList() &lt;&lt; <span class="stringliteral">&quot;QuRTPlot2&quot;</span>;</div><div class="line">}</div></div><!-- fragment --><p>The <em>catalogue</em> is employed by the <a class="el" href="classQuXtraWidgetPluginLoader.html" title="The QuXtraWidgetPluginLoader class finds the plugin that exports a widget with a given file name.">QuXtraWidgetPluginLoader</a> to inform the client whether a given class is available or not. The <a class="el" href="classQuXtraWidgetPluginLoader.html" title="The QuXtraWidgetPluginLoader class finds the plugin that exports a widget with a given file name.">QuXtraWidgetPluginLoader</a> scans all <em>extra widget</em> plugins for a given class name.</p>
<p>Two last methods must be implemented, <em>name</em> and <em>description</em>. The code is self explanatory:</p>
<div class="fragment"><div class="line">QString RTPlotXWidgetPlugin::name()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;elettra.eu.rtplotxwidgetplugin&quot;</span>;</div><div class="line">}</div><div class="line"></div><div class="line">QString RTPlotXWidgetPlugin::description()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">    <span class="keywordflow">return</span> QString(<span class="stringliteral">&quot;%1 provides a \&quot;realtime plots\&quot; that connect and display arrays &quot;</span></div><div class="line">                   <span class="stringliteral">&quot;from some special Elettra Tango devices exporting \&quot;real time\&quot; commands.&quot;</span>).arg(name());</div><div class="line">}</div></div><!-- fragment --><h3>3. The client.</h3>
<p>The client is an application which skeleton can be generated with the utility</p>
<div class="fragment"><div class="line">cumbia new project</div></div><!-- fragment --><p>In this example, the code to load the plugin and instantiate the <em>real time plot</em> is written in the constructor. First, we get the plugin that provides the class we need, <em>QuRTPlot2</em> and, if available, we ask the instantiation of the object:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;RTPlotXWPluginExample.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// cumbia-tango</span></div><div class="line"><span class="preprocessor">#include &lt;cuserviceprovider.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cumacros.h&gt;</span></div><div class="line"><span class="comment">// cumbia-tango</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;QGridLayout&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;QVariant&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quxtrawidgetpluginloader_8h.html">quxtrawidgetpluginloader.h</a>&gt;</span></div><div class="line"></div><div class="line">RTPlotXWPluginExample::RTPlotXWPluginExample(CumbiaTango *cut, QWidget *parent) :</div><div class="line">    QWidget(parent)</div><div class="line">{</div><div class="line">    <span class="comment">// cumbia-tango</span></div><div class="line">    cu_t = cut;</div><div class="line">    m_log = <span class="keyword">new</span> CuLog(&amp;m_log_impl);</div><div class="line">    cu_t-&gt;getServiceProvider()-&gt;registerService(CuServices::Log, m_log);</div><div class="line">    <span class="comment">// cumbia-tango</span></div><div class="line"></div><div class="line">    QGridLayout *lo = <span class="keyword">new</span> QGridLayout(<span class="keyword">this</span>);</div><div class="line">    <a class="code" href="classQuXtraWidgetPluginLoader.html">QuXtraWidgetPluginLoader</a> xwpl;</div><div class="line">    <a class="code" href="classQuXtraWidgetPluginI.html">QuXtraWidgetPluginI</a> *pi = xwpl.<a class="code" href="classQuXtraWidgetPluginLoader.html#a6d86c1f05b4f2650cde38a5daa1b7d7d">getPlugin</a>(<span class="stringliteral">&quot;QuRTPlot2&quot;</span>);</div><div class="line">    <span class="keywordflow">if</span>(pi) {</div><div class="line">        QWidget *rtPlot = pi-&gt;<a class="code" href="classQuXtraWidgetPluginI.html#a670bbabc0bb6f3df90c22a851afe6b51">create</a>(<span class="stringliteral">&quot;QuRTPlot2&quot;</span>, parent, cut, this-&gt;cu_tango_r_fac);</div><div class="line">        <span class="keywordflow">if</span>(rtPlot) {</div><div class="line">                lo-&gt;addWidget(rtPlot);</div><div class="line">                rtPlot-&gt;setObjectName(<span class="stringliteral">&quot;rtPlot&quot;</span>);</div><div class="line">                <span class="comment">// either use the &quot;source&quot; property</span></div><div class="line">                rtPlot-&gt;setProperty(<span class="stringliteral">&quot;source&quot;</span>, qApp-&gt;arguments()[1]);</div><div class="line">                <span class="comment">// or</span></div><div class="line">                <span class="comment">// dynamic_cast&lt;QuXtraWidgetI *&gt;(rtPlot)-&gt;setLink(qApp-&gt;arguments().at(1));</span></div><div class="line">        } <span class="comment">// else: very strange</span></div><div class="line">    } <span class="comment">// else error: the plugin is not [correctly] installed</span></div><div class="line">}</div></div><!-- fragment --><p>If everything is as expected, build the plugin, then the client app. You'll get a plot that not only displays arrays from <em>elettra real time</em> devices, but also configures the polling period and the number of samples through a <em>popup dialog</em> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Sep 13 2019 15:31:06 for cumbia-qtcontrols by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
