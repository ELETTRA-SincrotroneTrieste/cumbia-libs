<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cumbia formula plugin: Formula plugin: enhance your application combining readings into formulas and functions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">cumbia formula plugin<span id="projectnumber">&#160;4.x</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search',false);
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<div><div class="header">
  <div class="headertitle"><div class="title">Formula plugin: enhance your application combining readings into formulas and functions </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a class="el" href="classCuFormulaPlugin.html">CuFormulaPlugin</a> class  </p>
<h1><a class="anchor" id="intro_sec"></a>
Introduction</h1>
<p><a class="el" href="classCuFormulaPlugin.html">CuFormulaPlugin</a> lets you employ <em>sources</em> in the form of <em>javascript functions</em>, rather than simple variable names exported by the control system(s) in use.</p>
<h1><a class="anchor" id="usage_sec"></a>
Usage</h1>
<dl class="section user"><dt>1. Load the plugin</dt><dd></dd></dl>
<p>The application must first load the <em>formula plugin</em>. Once loaded, the <a class="el" href="classCuFormulaPlugin.html#a93065cd905d5e2f8d33acd676783f591" title="plugin is initialized with application wide CumbiaPool and CuControlsFactoryPool">CuFormulaPlugin::initialize</a> method must be called passing a pointer to a previously allocated CumbiaPool and a reference to a CuControlsFactoryPool. The <a class="el" href="classCuFormulaPlugin.html#a93065cd905d5e2f8d33acd676783f591" title="plugin is initialized with application wide CumbiaPool and CuControlsFactoryPool">CuFormulaPlugin::initialize</a> function takes care of registering the default "formula://" domain in CumbiaPool and CuControlsFactoryPool, by calling CumbiaPool::registerImpl and CuControlsFactoryPool::setSrcPatterns</p>
<p>The <a class="el" href="classCuFormulaPlugin.html#a93065cd905d5e2f8d33acd676783f591" title="plugin is initialized with application wide CumbiaPool and CuControlsFactoryPool">CuFormulaPlugin::initialize</a> shall be called <em>before any source setup</em> inside the application and <em>after all other modules</em> (tango,epics,http,...) have been registered to the <em>pools</em>. In this way, all sources can use the formula plugin and the sources used by the formula plugin can use the cumbia engines available in the application.</p>
<div class="fragment"><div class="line"><span class="comment">// cumbia</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiapool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;quapps.h&gt;</span></div>
<div class="line"><span class="comment">// formula plugin</span></div>
<div class="line"><span class="preprocessor">#include &lt;cupluginloader.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuformulaplugininterface.h&gt;</span></div>
<div class="line"> </div>
<div class="line">MyApp::MyApp(CumbiaPool *cumbia_pool, QWidget *parent) :</div>
<div class="line">    QWidget(parent)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// module loader first: initialize cumbia pool and factory pool</span></div>
<div class="line">    CuModuleLoader mloader(cumbia_pool, &amp;m_ctrl_factory_pool, &amp;m_log_impl);</div>
<div class="line">    CuPluginLoader pl;</div>
<div class="line">    QObject *o;</div>
<div class="line">    CuFormulaPluginI *formula_p = pl.get&lt;CuFormulaPluginI&gt;(<span class="stringliteral">&quot;cuformula-plugin.so&quot;</span>, &amp;o);</div>
<div class="line">    <span class="keywordflow">if</span>(formula_p) { <span class="comment">// ok</span></div>
<div class="line">        formula_p-&gt;initialize(cumbia_pool, m_ctrl_factory_pool);</div>
<div class="line">        ui = <span class="keyword">new</span> Ui::MyApp;   <span class="comment">// create and setup ui</span></div>
<div class="line">        ui-&gt;setupUi(<span class="keyword">this</span>, cu_pool, m_ctrl_factory_pool);</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
</div><!-- fragment --><dl class="section user"><dt>2. <em>formula</em> source syntax</dt><dd></dd></dl>
<p>As suggested by the discusssion above, in order to be interpreted by the plugin a <em>source</em> must start with the "formula://" pattern. The complete source expression will then contain the list of control system source names within curly braces, comma separated, and a <em>javascript</em> function expressing the relations among the sources:</p>
<div class="fragment"><div class="line">QString src = <span class="stringliteral">&quot;formula://{a/test/device/att,b/test/device/att} function(a, b) { return a + b }&quot;</span></div>
<div class="line">my_sum_label-&gt;setSource(src); <span class="comment">// let my_sum_label be a QuLabel</span></div>
</div><!-- fragment --><p>The result of the formula specified in the code will be displayed in the label.</p>
<dl class="section user"><dt>Example. la-cumparsita</dt><dd></dd></dl>
<p>The image below shows formulas applied to a couple of waveforms generated by the <em>TangoTest</em> device. You can see the <em>sum</em> and <em>diff</em> curves, calculated by <em>javascript</em> functions from the readings of the two <em>wave</em> attributes. On the right, two <em>QuLabel</em> show the average value of the waves for each of the two sources.</p>
<div class="image">
<img src="cumparsita.png" alt=""/>
<div class="caption">
Figure 1. la-cumparsita shows a sum and a difference curve. Average labels on the right</div></div>
 <dl class="section user"><dt>3. Formulas in the <em>Qt Designer</em></dt><dd></dd></dl>
<p>As every other source, a <em>formula</em> can be set directly from the Qt designer form editor. Right click on any <em>cumbia-qtcontrols</em> widget and select the <em>Edit connection...</em> action. In the popup dialog, check the <em>Formula</em> box and write the <em>JavaScript</em> function in the text area below. The function can be also loaded from a file: click on the <em>From js script...</em> button and choose the input file. The contents of the file are copied into the text area and when the "OK" button is clicked they become the <em>source</em> of the control widget. If one provides a <em>Source alias</em> in the dedicated text field, it may be used as an <em>alias</em> for the formula, for example as a title of a plot curve (see figure above). The input parameters to the function, if provided, are replaced by the sources listed in curly braces in the top text line edit (see figure below).</p>
<dl class="section user"><dt>Note</dt><dd>The contents of the <em>javascript file</em> are <em>copied</em> into the <em>ui</em> file, so that the <em>js</em> file does not need to be part of the project. On the other hand, changing the <em>js</em> file alone is not enough to apply the changes back in the <em>source</em>: the file must be reloaded through the Qt designer <em>Edit connection...</em> dialog.</dd></dl>
<div class="image">
<img src="edit-source-formula.png" alt=""/>
<div class="caption">
Figure 2. Edit source dialog with a javascript function</div></div>
 <p>In the example above, the readings from the two sources</p>
<ul>
<li>$1/wave and </li>
<li>$2/wave</li>
</ul>
<p>will replace the <em>a,b</em> input parameters in the <em>Javascript function</em>. A third vector, named <em>c</em> in the function, is returned and used to provide data for the <em>Source 4</em>, that's been given the <em>diff</em> alias (as in Figure 1).</p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
