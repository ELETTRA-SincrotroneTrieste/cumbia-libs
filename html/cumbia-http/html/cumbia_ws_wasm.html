<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cumbia-http: Qt, cumbia, websocket, WebAssembly application setup and test</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cumbia-http
   &#160;<span id="projectnumber">1.x</span>
   </div>
   <div id="projectbrief">Qt widgets on top of the cumbia C++ library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Qt, cumbia, websocket, WebAssembly application setup and test </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_cumbia_http_wasm"></a> Enabling multi engine support for a cumbia app allows executing one application to rely on different engines without any code modification. For instance, on platforms where Tango or EPICS control systems cannot be built, the application can fetch data through a proxy server over WebSockets or http. Applications that targeted only a specific enging (e.g. Tango), need a small modification to be ported to the corresponding <em>multi engine</em> version.</p>
<h3>Note</h3>
<p>It is recommended to enable the <em>multi engine</em> support <em>for all projects</em>, even for those intended to run on a specific engine only. This leaves the application open to rely on new engines in the future or face particular test environments.</p>
<h1>Setup Qt and cumbia for WebAssembly</h1>
<p>If you haven't done it yet, prepare and install the Qt and cumbia builds for WebAssembly described <a href="../../cumbia/html/cumbia_wasm.html">here</a>.</p>
<h3>Note</h3>
<p>In order to use the cumbia tools for development and testing, like <em>cumbia new project</em>, <em>cuuimake</em>, <em>cumbia read</em> or <em>cumbia client</em>, the <em>cumbia-libs</em> for C++ must be installed.</p>
<p>If they are installed under</p>
<div class="fragment"><div class="line">/home/test/.local/cumbia-libs/</div>
</div><!-- fragment --><p>you can execute</p>
<blockquote class="doxtable">
<p>source /home/test/.local/cumbia-libs/bin/cusetenv.sh </p>
</blockquote>
<p>to set up the environment in the current shell</p>
<h1>Build the <em>websocket server</em> for test purposes.</h1>
<p>The <em>websocket server</em> transforms client requests over WebSockets into engine-specific (Tango, EPICS) read and write operations. Results are sent back to the client over the same WebSocket. The <em>websocket server</em> is a C++ application that must have access to the desired control systems (Tango, EPICS) of which it is thus a <em>client</em>.</p>
<h3>Disclaimer</h3>
<p><em>cumbia-websocket-proxy-server</em> is a small Qt project uniquely aimed at testing websocket based C++ and WebAssembly applications and not intended for production.</p>
<h2>Download and build cumbia-websocket-proxy-server</h2>
<p>Download the sources</p>
<blockquote class="doxtable">
<p>cd ~/devel </p>
</blockquote>
<blockquote class="doxtable">
<p>git clone <a href="https://github.com/ELETTRA-SincrotroneTrieste/cumbia-websocket-proxy-server.git">https://github.com/ELETTRA-SincrotroneTrieste/cumbia-websocket-proxy-server.git</a> </p>
</blockquote>
<blockquote class="doxtable">
<p>cd cumbia-websocket-proxy-server </p>
</blockquote>
<p><em>NOTE</em> C++ qmake is used</p>
<blockquote class="doxtable">
<p>qmake INSTALL_ROOT=/home/test/.local/cumbia-libs </p>
</blockquote>
<blockquote class="doxtable">
<p>make -j9 &amp;&amp; make install </p>
</blockquote>
<h2>Start the cumbia-websocket-proxy-server</h2>
<p>The server can be run with the following command</p>
<blockquote class="doxtable">
<p>cumbia-websocket-proxy-server </p>
</blockquote>
<p>if the <code>bash source /home/test/.local/cumbia-libs/bin/cusetenv.sh</code> instruction has been previously imparted.</p>
<h1>Application setup for WebAssembly and websocket engine</h1>
<h2>1. Start a new project with cumbia-websocket engine support</h2>
<p>Start the <em>new project wizard</em></p>
<blockquote class="doxtable">
<p>cumbia new project </p>
</blockquote>
<p>In the top right <em>Support</em> box select <em>multi-engine</em></p>
<p>Fill in the required fields and click on the <em>Create</em> button.</p>
<p>Let's now inspect the skeleton generated by the wizard:</p>
<h3>Header file</h3>
<p>The header file exploits the <em>multi engine</em> functionalities offered by the <em>CumbiaPool</em> and <em>CuControlsFactoryPool</em>:</p>
<div class="fragment"><div class="line"><span class="keyword">private</span>:</div>
<div class="line">    Ui::MyClass *ui;</div>
<div class="line">    CumbiaPool *cu_pool;</div>
<div class="line">    CuControlsFactoryPool m_ctrl_factory_pool;</div>
</div><!-- fragment --><h3>CPP file</h3>
<p>The CPP skeleton file comes with plenty of comments. Substantially, since the application must be enabled to rely on different engines at runtime, it must be designed so that this adaptation does not require code change and recompilation.</p>
<p><em>QCommandLineParser</em> is used to determine whether the user launched the program with a parameter specifying the <em>websocket-url</em>. If so, <em>cumbia-websocket</em> engine is set up and <em>cumbia-tango</em> and <em>cumbia-epics</em> are left out. Exclusive engine loading allows the same syntax for sources and targets across the native and <em>proxied</em> engines (for instance <em>my/tango/device/attribute</em>, <em>$1/my_attribute</em>).</p>
<p>Websocket compatibility of source syntax with the Tango one is made possible by the <em>CuWsTangoReplaceWildcards</em> class, that mimics the <em><a class="elRef" href="../../qumbia-tango-controls/html/classCuTangoReplaceWildcards.html">CuTangoReplaceWildcards</a></em>, allowing for the <em>$x/attribute</em> and <em>$y-&gt;command</em> wildcards. Source <em>patterns</em> are provided by the CuWsTangoHelper.srcPatterns, that copies the src patterns defined by the Tango engine.</p>
<p>In the following section, the generated C++ file will be further commented.</p>
<p>Once the skeleton code is generated, you can proceed to editing. When the application is launched with the server address as option, the WebSocket engine is used. The native Tango (EPICS) engine is used otherwise.</p>
<h2>2. Migrate an engine specific project to a multi-engine support including cumbia-websocket</h2>
<p>If an existing <em>cumbia</em> project was created with a single engine in mind, a few code modifications are needed to port it to the multi engine form. In this example, we assume to be working on a Tango app and we want to support the <em>websocket</em> and <em>tango</em> engines only.</p>
<h3>qmake project file</h3>
<p>Add the support for the necessary engines</p>
<div class="fragment"><div class="line">isEmpty(CUMBIA_ROOT) {</div>
<div class="line">    CUMBIA_ROOT=/usr/local/cumbia-libs</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">linux-g++ {</div>
<div class="line">    exists  ($${CUMBIA_ROOT}/include/qumbia-tango-controls/qumbia-tango-controls.pri) {</div>
<div class="line">        include ($${CUMBIA_ROOT}/include/qumbia-tango-controls/qumbia-tango-controls.pri)</div>
<div class="line">    }</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">    # include cumbia-qtcontrols for necessary qt engine-unaware dependency (widgets, qwt, ...)</span></div>
<div class="line">    include ($${CUMBIA_ROOT}/include/cumbia-qtcontrols/cumbia-qtcontrols.pri)</div>
<div class="line">    include ($${CUMBIA_ROOT}/include/cumbia-websocket/cumbia-websocket.pri)</div>
<div class="line">}</div>
</div><!-- fragment --><p>Dependencies from qtx11extras should be removed or moved within the linux-g++ scope. Removing qtx11extras support implies removing or conditionally include sections of code related to X, like for example those using QX11Info, calling XSetCommand and so on.</p>
<h3>Header File</h3>
<p>The following lines</p>
<div class="fragment"><div class="line"><span class="comment">// - to be removed</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutcontrolsreader_8h.html">cutcontrolsreader.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutcontrolswriter_8h.html">cutcontrolswriter.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiatango.h&gt;</span></div>
<div class="line"><span class="comment">// -</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MyTangoApp : <span class="keyword">public</span> QWidget</div>
<div class="line">{</div>
<div class="line">    Q_OBJECT</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// - to be replaced with another version of the constructor</span></div>
<div class="line">    <span class="keyword">explicit</span> MyTangoApp(CumbiaTango *cut, QWidget *parent = 0);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// - to be removed</span></div>
<div class="line">    CumbiaTango *cu_t;</div>
<div class="line">    <a class="codeRef" href="../../qumbia-tango-controls/html/classCuTReaderFactory.html">CuTReaderFactory</a> cu_tango_r_fac;</div>
<div class="line">    <a class="codeRef" href="../../qumbia-tango-controls/html/classCuTWriterFactory.html">CuTWriterFactory</a> cu_tango_w_fac;</div>
<div class="line">    <span class="comment">// -</span></div>
<div class="ttc" id="aclassCuTReaderFactory_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/classCuTReaderFactory.html">CuTReaderFactory</a></div></div>
<div class="ttc" id="aclassCuTWriterFactory_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/classCuTWriterFactory.html">CuTWriterFactory</a></div></div>
<div class="ttc" id="acutcontrolsreader_8h.html_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/cutcontrolsreader_8h.html">cutcontrolsreader.h</a></div></div>
<div class="ttc" id="acutcontrolswriter_8h.html_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/cutcontrolswriter_8h.html">cutcontrolswriter.h</a></div></div>
</div><!-- fragment --><p>must be replaced by</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cucontrolsfactorypool.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>CumbiaPool;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MyClass : <span class="keyword">public</span> QWidget</div>
<div class="line">{</div>
<div class="line">    Q_OBJECT</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">explicit</span> MyClass(CumbiaPool *cu_p, QWidget *parent = 0); <span class="comment">// the constructor changes</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line">    CumbiaPool *cu_pool;   <span class="comment">// we need CumbiaPool</span></div>
<div class="line">    CuControlsFactoryPool m_ctrl_factory_pool;  <span class="comment">// we need CuControlsFactoryPool</span></div>
</div><!-- fragment --><h3>The <em>main.cpp</em> file</h3>
<p>The old main.cpp file contained these lines</p>
<div class="fragment"><div class="line"><span class="comment">// - to be removed</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiatango.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="codeRef" href="../../qumbia-epics-controls/html/label_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div>
<div class="line">    <span class="comment">// - this must be removed</span></div>
<div class="line">    CumbiaTango *cu_t = <span class="keyword">new</span> CumbiaTango(<span class="keyword">new</span> CuThreadFactoryImpl(), <span class="keyword">new</span> QThreadsEventBridgeFactory());</div>
<div class="line">    MyClass *w = <span class="keyword">new</span> MyClass(cu_t, NULL); <span class="comment">// - and this</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">    <span class="keywordtype">int</span> ret = qu_app.exec();</div>
<div class="line">    <span class="comment">// delete resources and return</span></div>
<div class="line">    <span class="keyword">delete</span> w;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// - and this must be removed</span></div>
<div class="line">    <span class="keyword">delete</span> cu_t;</div>
<div class="line">}</div>
<div class="ttc" id="alabel_2main_8cpp_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="../../qumbia-epics-controls/html/label_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div></div>
</div><!-- fragment --><p>and the new main.cpp requires the following additions:</p>
<div class="fragment"><div class="line"><span class="comment">// + add</span></div>
<div class="line"><span class="preprocessor">#include &lt;cumbiapool.h&gt;</span></div>
<div class="line"><span class="comment">// -</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="codeRef" href="../../qumbia-epics-controls/html/label_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div>
<div class="line">    <span class="comment">// + this must be added</span></div>
<div class="line">    CumbiaPool *cu_p = <span class="keyword">new</span> CumbiaPool();</div>
<div class="line">    MyClass *w = <span class="keyword">new</span> MyClass(cu_p, <span class="keyword">nullptr</span>);</div>
<div class="line">    <span class="comment">// -</span></div>
<div class="line">    w-&gt;show();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> ret = qu_app.exec();</div>
<div class="line">    <span class="comment">// delete resources and return</span></div>
<div class="line">    <span class="keyword">delete</span> w;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// + add these lines according to engines allocated in cpp class file (see below)</span></div>
<div class="line">    Cumbia *c = cu_p-&gt;get(<span class="stringliteral">&quot;tango&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(c) <span class="keyword">delete</span> c;</div>
<div class="line">    c = cu_p-&gt;get(<span class="stringliteral">&quot;ws&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(c) <span class="keyword">delete</span> c;</div>
<div class="line">}</div>
</div><!-- fragment --><h3>The <em>cpp</em> file</h3>
<p>The old constructor</p>
<div class="fragment"><div class="line">MyTangoApp::MyTangoApp(CumbiaTango *cut, QWidget *parent) : <span class="comment">// this is CumbiaTango specific</span></div>
<div class="line">    QWidget(parent)</div>
</div><!-- fragment --><p>will be replaced by the multi engine constructor (with CumbiaPool as first parameter)</p>
<div class="fragment"><div class="line">MyClass::MyClass(CumbiaPool *cumbia_pool, QWidget *parent) : QWidget(parent), ui(new <a class="codeRef" href="../../qumbia-epics-controls/html/namespaceUi.html">Ui</a>::MyClass)</div>
<div class="ttc" id="anamespaceUi_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/namespaceUi.html">Ui</a></div></div>
</div><!-- fragment --><p>this is removed</p>
<div class="fragment"><div class="line">ui-&gt;setupUi(<span class="keyword">this</span>, cu_t, cu_tango_r_fac, cu_tango_w_fac);</div>
</div><!-- fragment --><p>and a new piece of code needed to implement what described in the previous section must be introduced:</p>
<ul>
<li>includes: you can see the multiple engines support. In this document we reduce the number of engines to the Tango and WebSocket ones. You can look at a skeleton generated by <em>cumbia new project</em> for a more complete example. qumbia-apps/qumbia-client and qumbia-apps/qumbia-reader are good examples as well.</li>
</ul>
<h3>Note</h3>
<p>Tango engine is registered if the application has not been started with a parameter indicating a <em>websocket address</em> (see comments to code, (1) and (2)) In this way applications can rely <em>either</em> on websocket <em>or</em> Tango without changing the definition of their sources (i.e. without code changes and rebuild)</p>
<div class="fragment"><div class="line"><span class="comment">// + to register log service</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuserviceprovider.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef CUMBIA_WEBSOCKET_VERSION</span></div>
<div class="line"><span class="preprocessor">#include &lt;cuwsregisterengine.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_TANGO_CONTROLS_VERSION</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-tango-controls/html/cutangoregisterengine_8h.html">cutangoregisterengine.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="ttc" id="acutangoregisterengine_8h.html_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/cutangoregisterengine_8h.html">cutangoregisterengine.h</a></div></div>
</div><!-- fragment --><p>The constructor becomes</p>
<div class="fragment"><div class="line">MyClass::MyClass(CumbiaPool *cumbia_pool, QWidget *parent) : QWidget(parent), ui(new <a class="codeRef" href="../../qumbia-epics-controls/html/namespaceUi.html">Ui</a>::MyClass)</div>
<div class="line">{</div>
<div class="line">    Cumbia *cuws = <span class="keyword">nullptr</span>, *cuta = <span class="keyword">nullptr</span>;</div>
<div class="line">    m_log = <span class="keyword">new</span> CuLog(&amp;m_log_impl);</div>
<div class="line">    <span class="comment">// cumbia-tango</span></div>
<div class="line"><span class="preprocessor">#ifdef CUMBIA_WEBSOCKET_VERSION</span></div>
<div class="line">    QCommandLineParser parser;</div>
<div class="line">    CuWsRegisterEngine wsre;</div>
<div class="line">    <span class="keywordflow">if</span>(wsre.hasCmdOption(&amp;parser, qApp-&gt;arguments())) {  <span class="comment">// (1)</span></div>
<div class="line">        cuws = wsre.registerWithDefaults(cumbia_pool, m_ctrl_factory_pool);</div>
<div class="line">        <span class="keyword">static_cast&lt;</span>CumbiaWebSocket *<span class="keyword">&gt;</span>(cuws)-&gt;openSocket();</div>
<div class="line">        cuws-&gt;getServiceProvider()-&gt;registerService(CuServices::Log, m_log);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef QUMBIA_TANGO_CONTROLS_VERSION</span></div>
<div class="line">    <span class="comment">// (2)</span></div>
<div class="line">    <span class="keywordflow">if</span>(cuws != <span class="keyword">nullptr</span>) {</div>
<div class="line">        <a class="codeRef" href="../../qumbia-tango-controls/html/classCuTangoRegisterEngine.html">CuTangoRegisterEngine</a> tare;</div>
<div class="line">        cuta = tare.<a class="codeRef" href="../../qumbia-tango-controls/html/classCuTangoRegisterEngine.html#af901da9eafc53012ca2bb5a2830167bc">registerWithDefaults</a>(cu_pool, m_ctrl_factory_pool);</div>
<div class="line">        cuta-&gt;getServiceProvider()-&gt;registerService(CuServices::Log, m_log);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    ui = <span class="keyword">new</span> Ui::MyClass;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// + setupUi with pools</span></div>
<div class="line">    ui-&gt;setupUi(<span class="keyword">this</span>, cumbia_pool, m_ctrl_factory_pool);</div>
<div class="line">}</div>
<div class="ttc" id="aclassCuTangoRegisterEngine_html"><div class="ttname"><a href="../../qumbia-tango-controls/html/classCuTangoRegisterEngine.html">CuTangoRegisterEngine</a></div></div>
<div class="ttc" id="aclassCuTangoRegisterEngine_html_af901da9eafc53012ca2bb5a2830167bc"><div class="ttname"><a href="../../qumbia-tango-controls/html/classCuTangoRegisterEngine.html#af901da9eafc53012ca2bb5a2830167bc">CuTangoRegisterEngine::registerWithDefaults</a></div><div class="ttdeci">CumbiaTango * registerWithDefaults(CumbiaPool *cu_pool, CuControlsFactoryPool &amp;fpoo)</div></div>
</div><!-- fragment --><h3>Note 1</h3>
<p>You may want to review the previous section, <em>Start a new project with cumbia-websocket engine support</em>. </p><h3>Note 2</h3>
<p>The example code needs to be inserted within the constructor of the application being ported to its <em>multi engine</em> version. </p><h3>Note 3</h3>
<p>Non necessary engines can be omitted by removing the sections within the <em>ifdef</em> sections, e.g. Tango. Further engines can be added in a similar way shown for Tango and websocket*.</p>
<p>For example, you only need modify the MyClass constructor in the cpp file:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef QUMBIA_EPICS_CONTROLS_VERSION</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="codeRef" href="../../qumbia-epics-controls/html/cuepregisterengine_8h.html">cuepregisterengine.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">MyClass::MyClass(CumbiaPool *cumbia_pool, QWidget *parent) : QWidget(parent), ui(new <a class="codeRef" href="../../qumbia-epics-controls/html/namespaceUi.html">Ui</a>::MyClass)</div>
<div class="line">{</div>
<div class="line">    Cumbia *cuepi = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="comment">// ..</span></div>
<div class="line"><span class="preprocessor">    #ifdef QUMBIA_EPICS_CONTROLS_VERSION</span></div>
<div class="line">        <a class="codeRef" href="../../qumbia-epics-controls/html/classCuEpRegisterEngine.html">CuEpRegisterEngine</a> epre;</div>
<div class="line">        cuep = epre.<a class="codeRef" href="../../qumbia-epics-controls/html/classCuEpRegisterEngine.html#a929861be5152dfd4150ce448b1ff90b2">registerWithDefaults</a>(cumbia_pool, m_ctrl_factory_pool);</div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line">    <span class="comment">// ..</span></div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aclassCuEpRegisterEngine_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/classCuEpRegisterEngine.html">CuEpRegisterEngine</a></div></div>
<div class="ttc" id="aclassCuEpRegisterEngine_html_a929861be5152dfd4150ce448b1ff90b2"><div class="ttname"><a href="../../qumbia-epics-controls/html/classCuEpRegisterEngine.html#a929861be5152dfd4150ce448b1ff90b2">CuEpRegisterEngine::registerWithDefaults</a></div><div class="ttdeci">CumbiaEpics * registerWithDefaults(CumbiaPool *cu_pool, CuControlsFactoryPool &amp;fpoo)</div></div>
<div class="ttc" id="acuepregisterengine_8h.html_html"><div class="ttname"><a href="../../qumbia-epics-controls/html/cuepregisterengine_8h.html">cuepregisterengine.h</a></div></div>
</div><!-- fragment --><p>and include the qumbia-epics-controls.pri file in the <em>qmake .pro project file</em>:</p>
<div class="fragment"><div class="line">include (/usr/local/cumbia-libs/include/qumbia-epics-controls/qumbia-epics-controls.pri)</div>
</div><!-- fragment --><h3>Note 2</h3>
<p>No other change in the code should be necessary, unless you need to grab references to specific <em>Cumbia</em> objects, i.e. CumbiaTango or CumbiaWebSocket.</p>
<p>In that case, the code to use will look like:</p>
<div class="fragment"><div class="line">CumbiaTango *c = <span class="keyword">static_cast&lt;</span>CumbiaTango *<span class="keyword">&gt;</span>(cu_pool-&gt;get(<span class="stringliteral">&quot;tango&quot;</span>));</div>
<div class="line"><span class="keywordflow">if</span>(c) {</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>and the old attributes referring to the CumbiaTango, <a class="elRef" href="../../qumbia-tango-controls/html/classCuTReaderFactory.html">CuTReaderFactory</a> or <a class="elRef" href="../../qumbia-tango-controls/html/classCuTWriterFactory.html">CuTWriterFactory</a> and declared in the header file will have to be removed.</p>
<h1>Build the application for WebAssembly</h1>
<h1>Run the C++ application for testing</h1>
<h1>Run the application in the browser</h1>
<blockquote class="doxtable">
<p>cd ~/devel </p>
</blockquote>
<blockquote class="doxtable">
<p>git clone <a href="https://github.com/emscripten-core/emsdk.git">https://github.com/emscripten-core/emsdk.git</a> </p>
</blockquote>
<blockquote class="doxtable">
<p>cd emsdk </p>
</blockquote>
<p>Qt and cumbia libraries have been tested with chromium browser, the Emscripten version 1.38.47 and Qt 5.14</p>
<blockquote class="doxtable">
<p>./emsdk install emscripten-1.38.47-fastcomp </p>
</blockquote>
<blockquote class="doxtable">
<p>./emsdk activate 1.38.47-fastcomp </p>
</blockquote>
<h2>Qt build and installation</h2>
<blockquote class="doxtable">
<p>cd ~/devel </p>
</blockquote>
<blockquote class="doxtable">
<p>git clone <a href="https://github.com/qt/qt5.git">https://github.com/qt/qt5.git</a> </p>
</blockquote>
<blockquote class="doxtable">
<p>cd qt </p>
</blockquote>
<blockquote class="doxtable">
<p>git checkout 5.14.2 </p>
</blockquote>
<blockquote class="doxtable">
<p>./init-repository </p>
</blockquote>
<h3>init-repository excluding some modules:</h3>
<blockquote class="doxtable">
<p>./init-repository &ndash;module-subset=all,-qtwayland,-qtx11extras,-qtwebengine,-qtpim,-qtquick3d,-qtmacextras </p>
</blockquote>
<p>Set the environment for <em>emscripten</em></p>
<blockquote class="doxtable">
<p>source ~/devel/emsdk/emsdk_env.sh </p>
</blockquote>
<h3>Command line arguments patch</h3>
<p>Check whether the following patch has been applied or not: it is important in order to pass command line arguments to applications</p>
<p><a href="https://codereview.qt-project.org/c/qt/qtbase/+/248624/6/src/plugins/platforms/wasm/qtloader.js#420">https://codereview.qt-project.org/c/qt/qtbase/+/248624/6/src/plugins/platforms/wasm/qtloader.js#420</a></p>
<h3>Configure, build and install</h3>
<p>Configure Qt with <em>-feature-thread</em>, skip tests and examples Further options can be found executing *./configure &ndash;help*</p>
<blockquote class="doxtable">
<p>./configure -xplatform wasm-emscripten -prefix /usr/local/qt-5.14.2-wasm -feature-thread -skip qtwebengine -skip qtquick3d -skip qtpurchasing -skip qtserialport -nomake examples -nomake tests -opensource -confirm-license &amp;&amp; make -j9 &amp;&amp; make install </p>
</blockquote>
<blockquote class="doxtable">
<p>make -j9 </p>
</blockquote>
<p>If you prefer, only a subset of modules can be built: <em>make module-qtbase module-qtdeclarative [other modules]</em></p>
<blockquote class="doxtable">
<p>[sudo] make install </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Mar 17 2021 09:46:18 for cumbia-http by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
